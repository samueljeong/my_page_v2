"""
expository.py
강해설교 스타일 - 본문 해설 중심 설교 구조

특징:
- 본문을 순서대로 해설
- 절별/단락별 분석
- 원어 분석 활용
- 해설 우선, 적용은 해설 중간중간

구조:
- 서론 (본문 배경 소개)
- 본론 (절별/단락별 순차 해설)
- 결론 (종합 적용)
"""

from typing import Dict, List, Any


class ExpositoryStyle:
    """강해설교 스타일"""

    id = "expository"
    name = "강해설교"
    description = "강해설교 - 본문을 순서대로 절별/단락별 해설"
    structure_type = "expository"

    # ═══════════════════════════════════════════════════════
    # Step2 구조 설계 지침
    # ═══════════════════════════════════════════════════════

    @staticmethod
    def get_step2_structure_guide() -> str:
        """Step2 구조 설계를 위한 가이드 반환"""
        return """
【 강해설교 구조 지침 】

▶ 핵심 원칙
- 본문을 순서대로 해설 (절 순서 유지)
- 원어 분석과 역사적 배경 활용
- 해설 중간에 적용 삽입
- 본문의 흐름을 따라가는 구조

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📌 서론 (본문 배경 소개)
   - 본문의 역사적/문학적 배경
   - 저자와 수신자 상황
   - 본문의 위치 (전후 맥락)
   - 오늘 본문에서 발견할 핵심
   - 분량: 전체의 10~15%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📌 본론 (절별/단락별 순차 해설)

   ▸ 단락 1: [1-3절] 또는 [첫 번째 단락]
      - 본문 읽기 (구절 전체 인용)
      - 핵심 단어 원어 분석
      - 구절별 의미 해설
      - → 적용: 우리에게 주는 의미

   ▸ 단락 2: [4-6절] 또는 [두 번째 단락]
      - 본문 읽기 (구절 전체 인용)
      - 핵심 단어 원어 분석
      - 구절별 의미 해설
      - → 적용: 우리에게 주는 의미

   ▸ 단락 3: [7-10절] 또는 [세 번째 단락]
      - 본문 읽기 (구절 전체 인용)
      - 핵심 단어 원어 분석
      - 구절별 의미 해설
      - → 적용: 우리에게 주는 의미

   (본문 길이에 따라 단락 수 조정)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📌 결론 (종합 적용)
   - 본문 전체의 핵심 메시지 요약
   - 단락별 적용 종합
   - 삶에서 실천할 것
   - 축복 및 기도
   - 분량: 전체의 10~15%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

▶ 강해설교 특징
1. 본문 순서를 따라감 (재배열 금지)
2. 원어 분석으로 깊이 있는 해설
3. 역사적/문화적 배경 설명
4. 해설과 적용의 균형

▶ 단락 구분 원칙
- 문맥상 의미 단위로 구분
- 2~4절 단위가 적당
- 본문 전체를 빠짐없이 다룸

▶ 각 단락 비중
- 각 단락은 비슷한 비중
- 핵심 단락에 약간 더 비중 가능
"""

    # ═══════════════════════════════════════════════════════
    # Step3/Step4 설교문 작성 지침
    # ═══════════════════════════════════════════════════════

    @staticmethod
    def get_step3_writing_guide() -> str:
        """Step3 설교문 작성을 위한 가이드 반환"""
        return """
【 강해설교 작성 지침 】

▶ 필수 체크리스트
□ 서론에서 본문 배경이 설명되었는가?
□ 본문을 순서대로 해설했는가? (순서 재배열 금지)
□ 각 단락에서 본문이 전체 인용되었는가?
□ 핵심 단어의 원어 분석이 포함되었는가?
□ 각 단락마다 적용이 삽입되었는가?
□ 결론에서 본문 전체가 요약되었는가?
□ 삶에서 실천할 것이 제시되었는가?

▶ 작성 순서
1. 서론: 본문 배경 + 전후 맥락 + 오늘의 핵심
2. 본론: 단락별로 (본문읽기 → 해설 → 적용)
3. 결론: 전체 요약 + 종합 적용 + 축복

▶ 강해설교의 강점 활용
- 원어 분석으로 깊이 있는 해설
- 역사/문화 배경으로 이해도 증가
- 본문 순서대로 진행하여 흐름 유지
- 해설 직후 적용으로 연결성 강화

▶ 주의사항
- 본문 순서를 재배열하지 마세요
- 해설만 하고 적용을 빠뜨리지 마세요
- 너무 학술적이면 청중이 이해하기 어려움
"""

    @staticmethod
    def get_step3_checklist() -> List[str]:
        """Step3 체크리스트 반환"""
        return [
            "서론에서 본문의 역사적/문학적 배경이 설명되었는가?",
            "본문의 전후 맥락이 설명되었는가?",
            "본문을 순서대로 해설했는가? (순서 재배열 없음)",
            "각 단락에서 해당 구절이 전체 인용되었는가?",
            "핵심 단어의 원어 분석이 포함되었는가?",
            "각 단락마다 적용이 삽입되었는가?",
            "결론에서 본문 전체의 핵심이 요약되었는가?",
            "삶에서 실천할 것이 구체적으로 제시되었는가?",
        ]

    # ═══════════════════════════════════════════════════════
    # 예화 가이드
    # ═══════════════════════════════════════════════════════

    @staticmethod
    def get_illustration_guide() -> str:
        """예화 배치 가이드 반환"""
        return """
【 강해설교 예화 배치 가이드 】

▶ 예화 배치 원칙
- 강해설교는 예화보다 해설이 중심
- 예화는 해설을 돕는 보조 역할
- 적용 부분에 예화 배치 권장

▶ 예화 유형 추천
- 본문 시대의 역사적 사례
- 원어의 의미를 설명하는 예시
- 적용을 돕는 현대 사례

▶ 주의사항
- 예화가 해설을 압도하지 않도록
- 본문 해설과 직접 연결된 예화만 사용
- 학술적 설명 후 예화로 이해를 도움
"""

    # ═══════════════════════════════════════════════════════
    # 구조 템플릿 (JSON)
    # ═══════════════════════════════════════════════════════

    @staticmethod
    def get_structure_template() -> Dict[str, Any]:
        """Step2 출력용 구조 템플릿"""
        return {
            "style": "expository",
            "style_name": "강해설교",
            "본문_범위": "",
            "서론": {
                "historical_background": "",
                "literary_context": "",
                "main_focus": "",
                "duration_percent": 10
            },
            "단락들": [
                {
                    "verses": "",
                    "text_quote": "",
                    "key_words": [],
                    "explanation": "",
                    "application": ""
                },
                {
                    "verses": "",
                    "text_quote": "",
                    "key_words": [],
                    "explanation": "",
                    "application": ""
                }
            ],
            "결론": {
                "summary": "",
                "combined_application": "",
                "practical_action": "",
                "blessing": ""
            }
        }

    # ═══════════════════════════════════════════════════════
    # 프롬프트 빌더
    # ═══════════════════════════════════════════════════════

    def build_step2_prompt(self, step1_result: Dict = None, context_data: Dict = None) -> str:
        """Step2 프롬프트 생성"""
        prompt = self.get_step2_structure_guide()

        if step1_result:
            # Step1의 원어 분석 결과 활용
            if step1_result.get("핵심_단어_분석"):
                prompt += "\n\n【 Step1 원어 분석 결과 활용 】\n"
                prompt += "위 원어 분석을 각 단락 해설에 적극 활용하세요.\n"

        prompt += "\n\n위 구조에 맞게 강해설교 구조를 설계하세요."
        prompt += "\n본문의 절 순서를 유지하며 단락을 구분하세요."
        return prompt

    def build_step3_prompt(self, step2_result: Dict = None, duration: str = "20분") -> str:
        """Step3/Step4 프롬프트 생성"""
        from . import READABILITY_GUIDE

        prompt = self.get_step3_writing_guide()
        prompt += f"\n\n【 분량 】\n{duration}\n"
        prompt += READABILITY_GUIDE
        prompt += "\n\n위 체크리스트와 가독성 지침을 모두 충족하는 강해설교를 작성하세요."
        prompt += "\n본문 순서를 유지하고, 해설과 적용을 균형있게 작성하세요."
        return prompt
