<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>ìƒí’ˆê´€ë¦¬ - Creator Lab</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%23667eea' width='32' height='32' rx='6'/><text x='16' y='22' font-size='18' fill='white' text-anchor='middle' font-weight='bold'>P</text></svg>">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/drama.css') }}?v=20241202">
  <style>
    .margin-tool-container { padding: 20px; }
    .margin-tool-container section {
      background: #fff;
      border-radius: 12px;
      padding: 16px 18px;
      margin-bottom: 16px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.05);
    }
    .margin-tool-container section h2 {
      margin: 0 0 8px;
      font-size: 16px;
      color: #111827;
    }
    .margin-tool-container section small {
      color: #6b7280;
      font-size: 12px;
      display: block;
      margin-bottom: 8px;
    }
    .margin-tool-container .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px 14px;
      margin-top: 8px;
    }
    .margin-tool-container label {
      font-size: 12px;
      color: #374151;
      display: block;
      margin-bottom: 3px;
    }
    .margin-tool-container input,
    .margin-tool-container select,
    .margin-tool-container textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }
    .margin-tool-container input:focus,
    .margin-tool-container select:focus {
      outline: 2px solid #4f46e5;
      border-color: transparent;
    }
    .margin-tool-container button {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .margin-tool-container button.primary { background: #4f46e5; color: #fff; }
    .margin-tool-container button.secondary { background: #e5e7eb; color: #111827; }
    .margin-tool-container button.danger { background: #f97373; color: #fff; }
    .margin-tool-container button.naver { background: #03c75a; color: #fff; }
    .margin-tool-container button.coupang { background: #e41e25; color: #fff; }
    .margin-tool-container button:disabled { opacity: 0.5; cursor: default; }
    .margin-tool-container .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .margin-tool-container .toolbar span {
      font-size: 12px;
      color: #6b7280;
    }
    .margin-tool-container table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 11px;
    }
    .margin-tool-container th,
    .margin-tool-container td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 4px;
      text-align: center;
    }
    .margin-tool-container th { background: #f9fafb; font-weight: 600; }
    .margin-tool-container tr:hover td { background: #f9fafb; }
    .margin-tool-container .text-left { text-align: left; }
    .margin-tool-container .badge-pos { color: #16a34a; font-weight: 600; }
    .margin-tool-container .badge-neg { color: #dc2626; font-weight: 600; }
    .margin-tool-container .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #ecfeff;
      color: #0f766e;
      gap: 4px;
    }
    .margin-tool-container .pill.naver { background: #e6f9ed; color: #03c75a; }
    .margin-tool-container .pill.coupang { background: #fde8e8; color: #e41e25; }
    .page-title { margin: 0 0 8px; font-size: 20px; color: #111827; }
    .page-desc { color: #6b7280; font-size: 13px; margin-bottom: 16px; }

    /* íŒë§¤ë°©ì‹ í† ê¸€ */
    .sale-type-toggle {
      display: flex;
      gap: 8px;
      margin: 10px 0;
    }
    .sale-type-toggle button {
      flex: 1;
      padding: 10px;
      border: 2px solid #d1d5db;
      background: #fff;
      color: #374151;
      font-weight: 500;
    }
    .sale-type-toggle button.active {
      border-color: #4f46e5;
      background: #eef2ff;
      color: #4f46e5;
    }

    /* ë§ˆì§„ ê°€ì´ë“œ ì¹´ë“œ */
    .margin-guide-card {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 1px solid #bae6fd;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }
    .margin-guide-card h4 {
      margin: 0 0 12px;
      color: #0369a1;
      font-size: 14px;
    }
    .price-guide-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .price-guide-item {
      flex: 1;
      min-width: 200px;
      background: #fff;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .price-guide-item.naver { border-left: 4px solid #03c75a; }
    .price-guide-item.coupang { border-left: 4px solid #e41e25; }
    .price-guide-item h5 {
      margin: 0 0 8px;
      font-size: 13px;
      color: #374151;
    }
    .price-guide-item .price {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
    }
    .price-guide-item .detail {
      font-size: 11px;
      color: #6b7280;
      margin-top: 8px;
    }
    .price-guide-item .detail div {
      display: flex;
      justify-content: space-between;
      padding: 2px 0;
    }

    /* ìˆ˜ìˆ˜ë£Œ ìƒì„¸ */
    .fee-breakdown {
      background: #f9fafb;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      font-size: 12px;
    }
    .fee-breakdown .row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px dashed #e5e7eb;
    }
    .fee-breakdown .row:last-child { border-bottom: none; font-weight: 600; }
    .fee-breakdown .row.total { color: #4f46e5; }

    /* í™˜ìœ¨ í‘œì‹œ */
    .exchange-rate-display {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .exchange-rate-display .rate-value {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }
    .exchange-rate-display .rate-info {
      font-size: 11px;
      color: #6b7280;
    }
    .exchange-rate-display .rate-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .exchange-rate-display .rate-status.live { background: #dcfce7; color: #16a34a; }
    .exchange-rate-display .rate-status.cached { background: #fef3c7; color: #d97706; }

    /* ê´€ì„¸ ì„ íƒ */
    .duty-select-group {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .duty-select-group select { flex: 2; }
    .duty-select-group .duty-rate-display {
      flex: 1;
      padding: 6px 12px;
      background: #f3f4f6;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
    }

    /* êµ¬ë§¤ëŒ€í–‰ ì¶”ê°€ í•„ë“œ */
    .proxy-shipping-field {
      display: none;
      margin-top: 10px;
      padding: 12px;
      background: #fef3c7;
      border-radius: 8px;
      border: 1px solid #fcd34d;
    }
    .proxy-shipping-field.visible { display: block; }
    .proxy-shipping-field label { color: #92400e; }
  </style>
</head>
<body>
  <div class="auth-header">
    <h1>Creator Lab</h1>
    <div class="auth-links">
      <a href="/" class="btn-home">í™ˆ</a>
    </div>
  </div>

  <div class="main-layout">
    <aside class="sidebar">
      <nav class="sidebar-nav">
        <a href="/drama" class="sidebar-item" data-page="drama">
          <span class="sidebar-icon">ğŸ¬</span>
          <span class="sidebar-label">ë“œë¼ë§ˆ ì œì‘</span>
        </a>
        <a href="/image" class="sidebar-item" data-page="image">
          <span class="sidebar-icon">ğŸ–¼ï¸</span>
          <span class="sidebar-label">ì´ë¯¸ì§€ ì œì‘</span>
        </a>
        <a href="/product" class="sidebar-item" data-page="product">
          <span class="sidebar-icon">ğŸ“¦</span>
          <span class="sidebar-label">ìƒí’ˆ ì œì‘</span>
        </a>
        <a href="/product-manage" class="sidebar-item active" data-page="product-manage">
          <span class="sidebar-icon">ğŸ·ï¸</span>
          <span class="sidebar-label">ìƒí’ˆê´€ë¦¬</span>
        </a>
      </nav>
    </aside>

    <div class="main-content">
      <div id="product-manage-app" class="margin-tool-container">
        <h1 class="page-title">ì¤‘êµ­ ìˆ˜ì… ìƒí’ˆ ë§ˆì§„ ê³„ì‚°ê¸°</h1>
        <p class="page-desc">ì›ê°€ / í™˜ìœ¨ / ìˆ˜ìˆ˜ë£Œ / ê´€ì„¸ / ë°°ì†¡ë¹„ë¥¼ ë°˜ì˜í•œ ë§ˆì§„ ì‹œë®¬ë ˆì´í„° (HSì½”ë“œëŠ” ê´€ì„¸ì‚¬ í™•ì¸ í•„ìˆ˜)</p>

        <!-- â‘  ê¸€ë¡œë²Œ ì„¤ì • -->
        <section id="global-config">
          <h2>â‘  ê¸€ë¡œë²Œ ì„¤ì •</h2>
          <small>í™˜ìœ¨ì€ ìë™ìœ¼ë¡œ ìµœì‹  ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. ê´€ì„¸ìœ¨ì€ ìƒí’ˆ ì¢…ë¥˜ì— ë”°ë¼ ê²°ì •ë©ë‹ˆë‹¤.</small>
          <div class="grid">
            <div>
              <label>CNY/KRW í™˜ìœ¨</label>
              <div class="exchange-rate-display">
                <span class="rate-value" id="exchangeRateDisplay">-</span>
                <div>
                  <span class="rate-status" id="rateStatus">ë¡œë”©ì¤‘</span>
                  <div class="rate-info" id="rateUpdateTime">-</div>
                </div>
                <button class="secondary" onclick="fetchExchangeRate()" style="padding:4px 8px; font-size:11px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
              </div>
              <input type="hidden" id="exchangeRate" value="207" />
            </div>
            <div>
              <label>ì¹´ë“œ í•´ì™¸ê²°ì œ ìˆ˜ìˆ˜ë£Œ</label>
              <select id="cardFeeRate">
                <option value="0">ì—†ìŒ (0%)</option>
                <option value="0.01">1.0%</option>
                <option value="0.015" selected>1.5% (ì¼ë°˜)</option>
                <option value="0.02">2.0%</option>
              </select>
            </div>
            <div>
              <label for="productCategory">ìƒí’ˆ ì¢…ë¥˜ (ê´€ì„¸ìœ¨ ê²°ì •)</label>
              <div class="duty-select-group">
                <select id="productCategory" onchange="updateDutyRate()">
                  <option value="0" data-hs="842121">ì—¬ê³¼ê¸°/ì •ìˆ˜ê¸°ë¥˜ (0%)</option>
                  <option value="0" data-hs="732690">ìŠ¤í…Œì¸ë ˆìŠ¤ ì œí’ˆ (0%)</option>
                  <option value="0.08" data-hs="841370">íŒí”„/ëª¨í„° (8%)</option>
                  <option value="0.08" data-hs="391740">í”Œë¼ìŠ¤í‹± ê´€/í”¼íŒ… (8%)</option>
                  <option value="0.08" data-hs="850440">ì „ì›ê³µê¸‰ì¥ì¹˜ (8%)</option>
                  <option value="0.08" data-hs="854370">ì „ê¸°ê¸°ê¸° ê¸°íƒ€ (8%)</option>
                  <option value="0.13" data-hs="940360">ê°€êµ¬ë¥˜ (13%)</option>
                  <option value="custom">ì§ì ‘ ì…ë ¥</option>
                </select>
                <div class="duty-rate-display" id="dutyRateDisplay">0%</div>
              </div>
              <input type="hidden" id="dutyRate" value="0" />
              <input type="text" id="customDutyRate" placeholder="ê´€ì„¸ìœ¨ ì§ì ‘ ì…ë ¥ (ì˜ˆ: 0.08)" style="display:none; margin-top:8px;" />
            </div>
          </div>
        </section>

        <!-- â‘¡ íŒë§¤ ìˆ˜ìˆ˜ë£Œ ì„¤ì • -->
        <section id="fee-config">
          <h2>â‘¡ íŒë§¤ ìˆ˜ìˆ˜ë£Œ ì„¤ì •</h2>
          <small>í”Œë«í¼ë³„ íŒë§¤ ìˆ˜ìˆ˜ë£Œì™€ ê¸°íƒ€ ë¹„ìš©ì„ ì„¤ì •í•©ë‹ˆë‹¤. ì‹¤ì œ ì •ì‚° ì‹œ ì°¨ê°ë˜ëŠ” ê¸ˆì•¡ë“¤ì…ë‹ˆë‹¤.</small>
          <div class="grid">
            <div>
              <label>ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ìˆ˜ìˆ˜ë£Œ</label>
              <select id="naverFeeRate">
                <option value="0.055">5.5% (ì˜ë¥˜/íŒ¨ì…˜)</option>
                <option value="0.06" selected>6.0% (ì¼ë°˜)</option>
                <option value="0.08">8.0% (ì‹í’ˆ)</option>
                <option value="0.10">10.0% (í™”ì¥í’ˆ)</option>
              </select>
              <div style="font-size:11px; color:#6b7280; margin-top:4px;">
                * ë„¤ì´ë²„í˜ì´ ê²°ì œìˆ˜ìˆ˜ë£Œ í¬í•¨
              </div>
            </div>
            <div>
              <label>ì¿ íŒ¡ ìˆ˜ìˆ˜ë£Œ</label>
              <select id="coupangFeeRate">
                <option value="0.08">8.0% (ìƒí™œìš©í’ˆ)</option>
                <option value="0.10" selected>10.0% (ì¼ë°˜)</option>
                <option value="0.105">10.5% (ê°€ì „)</option>
                <option value="0.12">12.0% (ì‹í’ˆ)</option>
              </select>
              <div style="font-size:11px; color:#6b7280; margin-top:4px;">
                * ë¡œì¼“ë°°ì†¡ ì•„ë‹Œ ê²½ìš° ê¸°ì¤€
              </div>
            </div>
            <div>
              <label>ë¶€ê°€ì„¸ìœ¨</label>
              <select id="vatRate">
                <option value="0.10" selected>10% (ì¼ë°˜)</option>
                <option value="0">ë©´ì„¸ ìƒí’ˆ</option>
              </select>
              <div style="font-size:11px; color:#6b7280; margin-top:4px;">
                * ìˆ˜ì… ì‹œ (ì›ê°€+ê´€ì„¸)ì˜ 10%
              </div>
            </div>
          </div>

          <div class="fee-breakdown" style="margin-top:16px;">
            <h4 style="margin:0 0 8px; font-size:13px;">ğŸ’¡ íŒë§¤ ì‹œ ë°œìƒí•˜ëŠ” ëª¨ë“  ë¹„ìš©</h4>
            <div class="row"><span>í”Œë«í¼ íŒë§¤ ìˆ˜ìˆ˜ë£Œ</span><span>ë„¤ì´ë²„ 6% / ì¿ íŒ¡ 10%</span></div>
            <div class="row"><span>ìˆ˜ì… ì‹œ ë¶€ê°€ì„¸</span><span>(ì›ê°€+ê´€ì„¸) Ã— 10%</span></div>
            <div class="row"><span>ê´€ì„¸</span><span>ì›ê°€ Ã— ê´€ì„¸ìœ¨ (í’ˆëª©ë³„ ìƒì´)</span></div>
            <div class="row"><span>ì¹´ë“œ í•´ì™¸ê²°ì œ ìˆ˜ìˆ˜ë£Œ</span><span>ì›ê°€ Ã— 1.5%</span></div>
            <div class="row"><span>ë°°ì†¡ë¹„ (í•œêµ­ìˆ˜ì…)</span><span>LCL ë˜ëŠ” í•­ê³µ ë°°ì†¡ë¹„</span></div>
            <div class="row"><span>ë°°ì†¡ë¹„ (êµ¬ë§¤ëŒ€í–‰)</span><span>ê°œë‹¹ í•´ì™¸ì§ë°°ì†¡ë¹„</span></div>
          </div>
        </section>

        <!-- â‘¢ ìƒí’ˆ ì¶”ê°€ / ë§ˆì§„ ì‹œë®¬ë ˆì´ì…˜ -->
        <section id="product-add-section">
          <h2>â‘¢ ìƒí’ˆ ì¶”ê°€ ë° ê°€ê²© ì‹œë®¬ë ˆì´ì…˜</h2>
          <small>íŒë§¤ ë°©ì‹ì„ ì„ íƒí•˜ê³ , ì›ê°€ì™€ ëª©í‘œ ë§ˆì§„ìœ¨ì„ ì…ë ¥í•˜ë©´ ì ì • íŒë§¤ê°€ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.</small>

          <!-- íŒë§¤ ë°©ì‹ ì„ íƒ -->
          <div class="sale-type-toggle">
            <button type="button" id="btn-import" class="active" onclick="setSaleType('import')">
              ğŸš¢ í•œêµ­ ìˆ˜ì… (LCL/í•­ê³µ)
            </button>
            <button type="button" id="btn-proxy" onclick="setSaleType('proxy')">
              ğŸ“¦ êµ¬ë§¤ëŒ€í–‰
            </button>
          </div>
          <input type="hidden" id="saleType" value="import" />

          <!-- êµ¬ë§¤ëŒ€í–‰ ì‹œ í•´ì™¸ë°°ì†¡ë¹„ -->
          <div class="proxy-shipping-field" id="proxyShippingField">
            <label for="proxyShippingCost">ê°œë‹¹ í•´ì™¸ ë°°ì†¡ë¹„ (ì›)</label>
            <input type="number" id="proxyShippingCost" placeholder="ì˜ˆ: 15000" value="0" />
            <div style="font-size:11px; color:#92400e; margin-top:4px;">
              * êµ¬ë§¤ëŒ€í–‰ ì‹œ ê°œë³„ ìƒí’ˆë§ˆë‹¤ ë¶€ê³¼ë˜ëŠ” í•´ì™¸ì§ë°°ì†¡ë¹„
            </div>
          </div>

          <div class="grid" style="margin-top:16px;">
            <div>
              <label for="newCategory">ì¹´í…Œê³ ë¦¬</label>
              <input id="newCategory" type="text" placeholder="ì˜ˆ: ì—¬ê³¼ê¸° / ë¶€ìì¬" />
            </div>
            <div>
              <label for="newName">ìƒí’ˆëª… *</label>
              <input id="newName" type="text" placeholder="ì˜ˆ: 22L ìŠ¤í…Œì¸ë ˆìŠ¤ ì—¬ê³¼ê¸°" />
            </div>
            <div>
              <label for="newCnyPrice">ì¤‘êµ­ ë‹¨ê°€ (CNY) *</label>
              <input id="newCnyPrice" type="number" step="0.01" placeholder="ì˜ˆ: 400" oninput="calculatePriceGuide()" />
            </div>
            <div>
              <label for="targetMargin">ëª©í‘œ ë§ˆì§„ìœ¨ (%)</label>
              <input id="targetMargin" type="number" value="35" min="0" max="100" oninput="calculatePriceGuide()" />
            </div>
            <div>
              <label for="newVolume">ë¶€í”¼ (L)</label>
              <input id="newVolume" type="number" step="0.1" placeholder="ì˜ˆ: 22" />
            </div>
            <div>
              <label for="newLink">êµ¬ë§¤ ë§í¬</label>
              <input id="newLink" type="url" placeholder="https://..." />
            </div>
          </div>

          <!-- ê°€ê²© ê°€ì´ë“œ ì¹´ë“œ -->
          <div class="margin-guide-card" id="priceGuideCard" style="display:none;">
            <h4>ğŸ“Š ëª©í‘œ ë§ˆì§„ìœ¨ <span id="targetMarginDisplay">35</span>% ë‹¬ì„±ì„ ìœ„í•œ ê¶Œì¥ íŒë§¤ê°€</h4>
            <div class="price-guide-row">
              <div class="price-guide-item naver">
                <h5>ğŸŸ¢ ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´</h5>
                <div class="price" id="naverRecommendPrice">-</div>
                <div class="detail">
                  <div><span>ì›ê°€ (KRW)</span><span id="naver-cost">-</span></div>
                  <div><span>ê´€ì„¸</span><span id="naver-duty">-</span></div>
                  <div><span>ë¶€ê°€ì„¸</span><span id="naver-vat">-</span></div>
                  <div><span>ì¹´ë“œìˆ˜ìˆ˜ë£Œ</span><span id="naver-card">-</span></div>
                  <div><span>ë°°ì†¡ë¹„</span><span id="naver-shipping">-</span></div>
                  <div><span>í”Œë«í¼ìˆ˜ìˆ˜ë£Œ</span><span id="naver-fee">-</span></div>
                  <div style="border-top:1px solid #e5e7eb; margin-top:4px; padding-top:4px; font-weight:600;">
                    <span>ì˜ˆìƒ ìˆœì´ìµ</span><span id="naver-profit" class="badge-pos">-</span>
                  </div>
                </div>
              </div>
              <div class="price-guide-item coupang">
                <h5>ğŸ”´ ì¿ íŒ¡</h5>
                <div class="price" id="coupangRecommendPrice">-</div>
                <div class="detail">
                  <div><span>ì›ê°€ (KRW)</span><span id="coupang-cost">-</span></div>
                  <div><span>ê´€ì„¸</span><span id="coupang-duty">-</span></div>
                  <div><span>ë¶€ê°€ì„¸</span><span id="coupang-vat">-</span></div>
                  <div><span>ì¹´ë“œìˆ˜ìˆ˜ë£Œ</span><span id="coupang-card">-</span></div>
                  <div><span>ë°°ì†¡ë¹„</span><span id="coupang-shipping">-</span></div>
                  <div><span>í”Œë«í¼ìˆ˜ìˆ˜ë£Œ</span><span id="coupang-fee">-</span></div>
                  <div style="border-top:1px solid #e5e7eb; margin-top:4px; padding-top:4px; font-weight:600;">
                    <span>ì˜ˆìƒ ìˆœì´ìµ</span><span id="coupang-profit" class="badge-pos">-</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="toolbar" style="margin-top:16px;">
            <button class="naver" id="addNaverBtn" onclick="addProduct('naver')">ë„¤ì´ë²„ ê°€ê²©ìœ¼ë¡œ ì¶”ê°€</button>
            <button class="coupang" id="addCoupangBtn" onclick="addProduct('coupang')">ì¿ íŒ¡ ê°€ê²©ìœ¼ë¡œ ì¶”ê°€</button>
            <button class="secondary" id="clearAllBtn">ì „ì²´ ì‚­ì œ</button>
            <span>â€» ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì € localStorageì— ì €ì¥ë©ë‹ˆë‹¤.</span>
          </div>
        </section>

        <!-- â‘£ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ -->
        <section id="product-list-section">
          <h2>â‘£ ë“±ë¡ëœ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸</h2>
          <div class="toolbar">
            <div>
              <label for="categoryFilter">ì¹´í…Œê³ ë¦¬</label>
              <select id="categoryFilter"><option value="all">ì „ì²´</option></select>
            </div>
            <div>
              <label for="platformFilter">í”Œë«í¼</label>
              <select id="platformFilter">
                <option value="all">ì „ì²´</option>
                <option value="naver">ë„¤ì´ë²„</option>
                <option value="coupang">ì¿ íŒ¡</option>
              </select>
            </div>
            <span id="summaryText">ìƒí’ˆ 0ê°œ</span>
          </div>

          <table id="productTable">
            <thead>
              <tr>
                <th>í”Œë«í¼</th>
                <th>íŒë§¤ë°©ì‹</th>
                <th class="text-left">ìƒí’ˆëª…</th>
                <th>ì›ê°€<br/>(CNY)</th>
                <th>ì›ê°€<br/>(KRW)</th>
                <th>íŒë§¤ê°€</th>
                <th>ì´ë¹„ìš©</th>
                <th>ìˆœì´ìµ</th>
                <th>ë§ˆì§„ìœ¨</th>
                <th>ë§í¬</th>
                <th>ì‚­ì œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- â‘¤ LCL ì‹œë®¬ë ˆì´ì…˜ -->
        <section id="lcl-config">
          <h2>â‘¤ LCL ë°°ì†¡ë¹„ ì‹œë®¬ë ˆì´ì…˜</h2>
          <small>í•œêµ­ ìˆ˜ì… ì‹œ LCL(ì†ŒëŸ‰í™”ë¬¼) ë°°ì†¡ë¹„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. ë°°ì†¡ëŒ€í–‰ì§€ ì •ë³´ëŠ” ì¶”í›„ ì—…ë°ì´íŠ¸ ì˜ˆì •.</small>
          <div class="grid">
            <div>
              <label for="lclTotalCost">í•œ ë²ˆ ì„ ì  LCL ì´ ë¹„ìš© (ì›)</label>
              <input id="lclTotalCost" type="number" value="0" placeholder="ì˜ˆ: 120000" oninput="updateLclDisplay()" />
            </div>
            <div>
              <label for="lclQuantity">ì„ ì  ìƒí’ˆ ê°œìˆ˜</label>
              <input id="lclQuantity" type="number" value="0" placeholder="ì˜ˆ: 30" oninput="updateLclDisplay()" />
            </div>
            <div>
              <label>ê°œë‹¹ LCL ë¹„ìš© (ìë™ ê³„ì‚°)</label>
              <div id="lclPerUnitDisplay" class="pill">ê°œë‹¹ LCL: 0 ì›</div>
            </div>
          </div>
          <div class="toolbar">
            <span>â€» LCL ë¹„ìš©ì„ ì…ë ¥í•˜ë©´ 'í•œêµ­ ìˆ˜ì…' ë°©ì‹ì˜ ëª¨ë“  ìƒí’ˆì— ìë™ ì ìš©ë©ë‹ˆë‹¤.</span>
          </div>
          <div style="background:#f0f9ff; border-radius:8px; padding:12px; margin-top:12px; font-size:12px; color:#0369a1;">
            <strong>ğŸ“¦ ë°°ì†¡ëŒ€í–‰ì§€ ì •ë³´</strong><br>
            ì¶”í›„ ë°°ì†¡ëŒ€í–‰ì§€ ê²¬ì ì„œ ì‚¬ì§„ì„ ì œê³µí•˜ì‹œë©´ ë¶„ì„í•˜ì—¬ ìë™ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
          </div>
        </section>
      </div>
    </div>
  </div>

  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">ë¡œë”© ì¤‘...</div>
  </div>
  <div id="status-bar" class="status-bar"></div>

  <script>
    let products = [];
    const STORAGE_KEY = "cn_margin_products_v2";
    const RATE_CACHE_KEY = "cny_krw_rate_cache";

    // DOM ìš”ì†Œ
    const exchangeRateInput = document.getElementById("exchangeRate");
    const exchangeRateDisplay = document.getElementById("exchangeRateDisplay");
    const rateStatus = document.getElementById("rateStatus");
    const rateUpdateTime = document.getElementById("rateUpdateTime");
    const cardFeeRateSelect = document.getElementById("cardFeeRate");
    const productCategorySelect = document.getElementById("productCategory");
    const dutyRateInput = document.getElementById("dutyRate");
    const dutyRateDisplay = document.getElementById("dutyRateDisplay");
    const customDutyRateInput = document.getElementById("customDutyRate");
    const naverFeeRateSelect = document.getElementById("naverFeeRate");
    const coupangFeeRateSelect = document.getElementById("coupangFeeRate");
    const vatRateSelect = document.getElementById("vatRate");
    const saleTypeInput = document.getElementById("saleType");
    const proxyShippingField = document.getElementById("proxyShippingField");
    const proxyShippingCostInput = document.getElementById("proxyShippingCost");
    const lclTotalCostInput = document.getElementById("lclTotalCost");
    const lclQuantityInput = document.getElementById("lclQuantity");
    const lclPerUnitDisplay = document.getElementById("lclPerUnitDisplay");
    const categoryFilterSelect = document.getElementById("categoryFilter");
    const platformFilterSelect = document.getElementById("platformFilter");
    const summaryText = document.getElementById("summaryText");
    const productTableBody = document.querySelector("#productTable tbody");
    const priceGuideCard = document.getElementById("priceGuideCard");

    function formatNumber(num) {
      if (isNaN(num)) return "-";
      return Math.round(num).toLocaleString("ko-KR");
    }

    function formatPercent(num) {
      if (isNaN(num)) return "-";
      return num.toFixed(1) + "%";
    }

    // í™˜ìœ¨ ê°€ì ¸ì˜¤ê¸° (API ì‚¬ìš©)
    async function fetchExchangeRate() {
      rateStatus.textContent = "ë¡œë”©ì¤‘";
      rateStatus.className = "rate-status";

      try {
        // ë¬´ë£Œ í™˜ìœ¨ API ì‚¬ìš© (exchangerate-api.com)
        const response = await fetch("https://api.exchangerate-api.com/v4/latest/CNY");
        const data = await response.json();
        const rate = data.rates.KRW;

        exchangeRateInput.value = rate.toFixed(2);
        exchangeRateDisplay.textContent = rate.toFixed(2) + "ì›";
        rateStatus.textContent = "ì‹¤ì‹œê°„";
        rateStatus.className = "rate-status live";
        rateUpdateTime.textContent = new Date().toLocaleString("ko-KR");

        // ìºì‹œ ì €ì¥
        localStorage.setItem(RATE_CACHE_KEY, JSON.stringify({
          rate: rate,
          timestamp: Date.now()
        }));

        calculatePriceGuide();
        renderTable();
      } catch (error) {
        console.error("í™˜ìœ¨ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
        // ìºì‹œëœ ê°’ ì‚¬ìš©
        const cached = localStorage.getItem(RATE_CACHE_KEY);
        if (cached) {
          const { rate, timestamp } = JSON.parse(cached);
          exchangeRateInput.value = rate.toFixed(2);
          exchangeRateDisplay.textContent = rate.toFixed(2) + "ì›";
          rateStatus.textContent = "ìºì‹œ";
          rateStatus.className = "rate-status cached";
          rateUpdateTime.textContent = new Date(timestamp).toLocaleString("ko-KR");
        } else {
          // ê¸°ë³¸ê°’ ì‚¬ìš©
          exchangeRateDisplay.textContent = "207ì›";
          rateStatus.textContent = "ê¸°ë³¸ê°’";
          rateStatus.className = "rate-status cached";
        }
      }
    }

    // ê´€ì„¸ìœ¨ ì—…ë°ì´íŠ¸
    function updateDutyRate() {
      const selected = productCategorySelect.value;
      if (selected === "custom") {
        customDutyRateInput.style.display = "block";
        customDutyRateInput.oninput = () => {
          const rate = parseFloat(customDutyRateInput.value) || 0;
          dutyRateInput.value = rate;
          dutyRateDisplay.textContent = (rate * 100).toFixed(1) + "%";
          calculatePriceGuide();
        };
      } else {
        customDutyRateInput.style.display = "none";
        dutyRateInput.value = selected;
        dutyRateDisplay.textContent = (parseFloat(selected) * 100).toFixed(1) + "%";
        calculatePriceGuide();
      }
    }

    // íŒë§¤ ë°©ì‹ ì„¤ì •
    function setSaleType(type) {
      saleTypeInput.value = type;
      document.getElementById("btn-import").classList.toggle("active", type === "import");
      document.getElementById("btn-proxy").classList.toggle("active", type === "proxy");
      proxyShippingField.classList.toggle("visible", type === "proxy");
      calculatePriceGuide();
    }

    // LCL ê°œë‹¹ ë¹„ìš©
    function getLclPerUnit() {
      const total = Number(lclTotalCostInput.value || 0);
      const qty = Number(lclQuantityInput.value || 0);
      if (total > 0 && qty > 0) return total / qty;
      return 0;
    }

    function updateLclDisplay() {
      const perUnit = getLclPerUnit();
      lclPerUnitDisplay.innerHTML = `ê°œë‹¹ LCL: ${formatNumber(perUnit)} ì›`;
      calculatePriceGuide();
      renderTable();
    }

    // ê°€ê²© ê°€ì´ë“œ ê³„ì‚°
    function calculatePriceGuide() {
      const cnyPrice = parseFloat(document.getElementById("newCnyPrice").value) || 0;
      const targetMargin = parseFloat(document.getElementById("targetMargin").value) || 35;

      if (cnyPrice <= 0) {
        priceGuideCard.style.display = "none";
        return;
      }

      priceGuideCard.style.display = "block";
      document.getElementById("targetMarginDisplay").textContent = targetMargin;

      const exchangeRate = parseFloat(exchangeRateInput.value) || 207;
      const dutyRate = parseFloat(dutyRateInput.value) || 0;
      const vatRate = parseFloat(vatRateSelect.value) || 0.1;
      const cardFeeRate = parseFloat(cardFeeRateSelect.value) || 0.015;
      const naverFeeRate = parseFloat(naverFeeRateSelect.value) || 0.06;
      const coupangFeeRate = parseFloat(coupangFeeRateSelect.value) || 0.10;
      const saleType = saleTypeInput.value;

      // ì›ê°€ ê³„ì‚°
      const baseCostKrw = cnyPrice * exchangeRate;
      const duty = baseCostKrw * dutyRate;
      const vat = (baseCostKrw + duty) * vatRate;
      const cardFee = baseCostKrw * cardFeeRate;

      // ë°°ì†¡ë¹„
      let shippingCost = 0;
      if (saleType === "import") {
        shippingCost = getLclPerUnit();
      } else {
        shippingCost = parseFloat(proxyShippingCostInput.value) || 0;
      }

      // ì´ ë¹„ìš© (í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ ì œì™¸)
      const totalCostBase = baseCostKrw + duty + vat + cardFee + shippingCost;

      // ëª©í‘œ ë§ˆì§„ìœ¨ ë‹¬ì„±ì„ ìœ„í•œ íŒë§¤ê°€ ê³„ì‚°
      // ìˆœì´ìµ = íŒë§¤ê°€ - ì´ë¹„ìš© - í”Œë«í¼ìˆ˜ìˆ˜ë£Œ
      // ë§ˆì§„ìœ¨ = ìˆœì´ìµ / íŒë§¤ê°€
      // targetMargin/100 = (íŒë§¤ê°€ - totalCostBase - íŒë§¤ê°€*platformFee) / íŒë§¤ê°€
      // targetMargin/100 = 1 - totalCostBase/íŒë§¤ê°€ - platformFee
      // totalCostBase/íŒë§¤ê°€ = 1 - platformFee - targetMargin/100
      // íŒë§¤ê°€ = totalCostBase / (1 - platformFee - targetMargin/100)

      const marginDecimal = targetMargin / 100;

      // ë„¤ì´ë²„
      const naverSellPrice = totalCostBase / (1 - naverFeeRate - marginDecimal);
      const naverPlatformFee = naverSellPrice * naverFeeRate;
      const naverProfit = naverSellPrice - totalCostBase - naverPlatformFee;

      // ì¿ íŒ¡
      const coupangSellPrice = totalCostBase / (1 - coupangFeeRate - marginDecimal);
      const coupangPlatformFee = coupangSellPrice * coupangFeeRate;
      const coupangProfit = coupangSellPrice - totalCostBase - coupangPlatformFee;

      // UI ì—…ë°ì´íŠ¸
      document.getElementById("naverRecommendPrice").textContent = formatNumber(naverSellPrice) + "ì›";
      document.getElementById("naver-cost").textContent = formatNumber(baseCostKrw) + "ì›";
      document.getElementById("naver-duty").textContent = formatNumber(duty) + "ì›";
      document.getElementById("naver-vat").textContent = formatNumber(vat) + "ì›";
      document.getElementById("naver-card").textContent = formatNumber(cardFee) + "ì›";
      document.getElementById("naver-shipping").textContent = formatNumber(shippingCost) + "ì›";
      document.getElementById("naver-fee").textContent = formatNumber(naverPlatformFee) + "ì›";
      document.getElementById("naver-profit").textContent = formatNumber(naverProfit) + "ì›";

      document.getElementById("coupangRecommendPrice").textContent = formatNumber(coupangSellPrice) + "ì›";
      document.getElementById("coupang-cost").textContent = formatNumber(baseCostKrw) + "ì›";
      document.getElementById("coupang-duty").textContent = formatNumber(duty) + "ì›";
      document.getElementById("coupang-vat").textContent = formatNumber(vat) + "ì›";
      document.getElementById("coupang-card").textContent = formatNumber(cardFee) + "ì›";
      document.getElementById("coupang-shipping").textContent = formatNumber(shippingCost) + "ì›";
      document.getElementById("coupang-fee").textContent = formatNumber(coupangPlatformFee) + "ì›";
      document.getElementById("coupang-profit").textContent = formatNumber(coupangProfit) + "ì›";

      // ì „ì—­ì— ì €ì¥ (ìƒí’ˆ ì¶”ê°€ ì‹œ ì‚¬ìš©)
      window.calculatedPrices = {
        naver: Math.round(naverSellPrice),
        coupang: Math.round(coupangSellPrice),
        naverProfit: naverProfit,
        coupangProfit: coupangProfit,
        totalCostBase: totalCostBase
      };
    }

    // ìƒí’ˆ ì¶”ê°€
    function addProduct(platform) {
      const category = document.getElementById("newCategory").value.trim() || "ë¯¸ë¶„ë¥˜";
      const name = document.getElementById("newName").value.trim();
      const cnyPrice = parseFloat(document.getElementById("newCnyPrice").value) || 0;
      const volume = document.getElementById("newVolume").value ? parseFloat(document.getElementById("newVolume").value) : null;
      const link = document.getElementById("newLink").value.trim();
      const saleType = saleTypeInput.value;

      if (!name || cnyPrice <= 0) {
        alert("ìƒí’ˆëª…ê³¼ ì¤‘êµ­ ë‹¨ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      if (!window.calculatedPrices) {
        alert("ê°€ê²© ê³„ì‚°ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
      }

      const sellPrice = window.calculatedPrices[platform];
      const profit = window.calculatedPrices[platform + "Profit"];
      const totalCost = window.calculatedPrices.totalCostBase;

      const product = {
        id: crypto.randomUUID(),
        category,
        name,
        cnyPrice,
        sellPrice,
        profit,
        totalCost,
        volume,
        link,
        platform,
        saleType,
        proxyShippingCost: saleType === "proxy" ? parseFloat(proxyShippingCostInput.value) || 0 : 0,
        exchangeRate: parseFloat(exchangeRateInput.value),
        dutyRate: parseFloat(dutyRateInput.value),
        vatRate: parseFloat(vatRateSelect.value),
        cardFeeRate: parseFloat(cardFeeRateSelect.value),
        platformFeeRate: platform === "naver" ? parseFloat(naverFeeRateSelect.value) : parseFloat(coupangFeeRateSelect.value),
        lclPerUnit: saleType === "import" ? getLclPerUnit() : 0,
        createdAt: new Date().toISOString()
      };

      products.push(product);
      saveProducts();

      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      document.getElementById("newName").value = "";
      document.getElementById("newCnyPrice").value = "";
      document.getElementById("newVolume").value = "";
      document.getElementById("newLink").value = "";
      priceGuideCard.style.display = "none";
      window.calculatedPrices = null;

      refreshAll();
    }

    // ë§ˆì§„ ì¬ê³„ì‚° (í…Œì´ë¸”ìš©)
    function recalculateMargin(product) {
      const exchangeRate = parseFloat(exchangeRateInput.value) || 207;
      const baseCostKrw = product.cnyPrice * exchangeRate;
      const duty = baseCostKrw * (product.dutyRate || 0);
      const vat = (baseCostKrw + duty) * (product.vatRate || 0.1);
      const cardFee = baseCostKrw * (product.cardFeeRate || 0.015);

      let shippingCost = 0;
      if (product.saleType === "import") {
        shippingCost = getLclPerUnit();
      } else {
        shippingCost = product.proxyShippingCost || 0;
      }

      const totalCost = baseCostKrw + duty + vat + cardFee + shippingCost;
      const platformFee = product.sellPrice * (product.platformFeeRate || 0.06);
      const profit = product.sellPrice - totalCost - platformFee;
      const marginRate = product.sellPrice > 0 ? (profit / product.sellPrice) * 100 : 0;

      return { baseCostKrw, totalCost, profit, marginRate };
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable() {
      const selectedCategory = categoryFilterSelect.value;
      const selectedPlatform = platformFilterSelect.value;
      productTableBody.innerHTML = "";

      let filtered = products;
      if (selectedCategory !== "all") {
        filtered = filtered.filter(p => p.category === selectedCategory);
      }
      if (selectedPlatform !== "all") {
        filtered = filtered.filter(p => p.platform === selectedPlatform);
      }

      filtered.forEach((product) => {
        const result = recalculateMargin(product);
        const tr = document.createElement("tr");

        // í”Œë«í¼
        const tdPlatform = document.createElement("td");
        tdPlatform.innerHTML = product.platform === "naver"
          ? '<span class="pill naver">ë„¤ì´ë²„</span>'
          : '<span class="pill coupang">ì¿ íŒ¡</span>';
        tr.appendChild(tdPlatform);

        // íŒë§¤ë°©ì‹
        const tdSaleType = document.createElement("td");
        tdSaleType.textContent = product.saleType === "import" ? "í•œêµ­ìˆ˜ì…" : "êµ¬ë§¤ëŒ€í–‰";
        tr.appendChild(tdSaleType);

        // ìƒí’ˆëª…
        const tdName = document.createElement("td");
        tdName.className = "text-left";
        tdName.textContent = product.name;
        tr.appendChild(tdName);

        // ì›ê°€ CNY
        const tdCny = document.createElement("td");
        tdCny.textContent = product.cnyPrice + "Â¥";
        tr.appendChild(tdCny);

        // ì›ê°€ KRW
        const tdKrw = document.createElement("td");
        tdKrw.textContent = formatNumber(result.baseCostKrw);
        tr.appendChild(tdKrw);

        // íŒë§¤ê°€
        const tdSell = document.createElement("td");
        tdSell.textContent = formatNumber(product.sellPrice);
        tr.appendChild(tdSell);

        // ì´ë¹„ìš©
        const tdCost = document.createElement("td");
        tdCost.textContent = formatNumber(result.totalCost);
        tr.appendChild(tdCost);

        // ìˆœì´ìµ
        const tdProfit = document.createElement("td");
        tdProfit.innerHTML = result.profit >= 0
          ? `<span class="badge-pos">+${formatNumber(result.profit)}</span>`
          : `<span class="badge-neg">${formatNumber(result.profit)}</span>`;
        tr.appendChild(tdProfit);

        // ë§ˆì§„ìœ¨
        const tdMargin = document.createElement("td");
        tdMargin.innerHTML = `<span class="${result.marginRate >= 0 ? "badge-pos" : "badge-neg"}">${formatPercent(result.marginRate)}</span>`;
        tr.appendChild(tdMargin);

        // ë§í¬
        const tdLink = document.createElement("td");
        if (product.link) {
          const linkBtn = document.createElement("button");
          linkBtn.className = "secondary";
          linkBtn.textContent = "ë³µì‚¬";
          linkBtn.style.padding = "4px 8px";
          linkBtn.style.fontSize = "10px";
          linkBtn.addEventListener("click", () => {
            navigator.clipboard.writeText(product.link).then(() => {
              linkBtn.textContent = "OK!";
              setTimeout(() => (linkBtn.textContent = "ë³µì‚¬"), 1000);
            });
          });
          tdLink.appendChild(linkBtn);
        } else {
          tdLink.textContent = "-";
        }
        tr.appendChild(tdLink);

        // ì‚­ì œ
        const tdDelete = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.className = "danger";
        delBtn.textContent = "X";
        delBtn.style.padding = "4px 8px";
        delBtn.style.fontSize = "10px";
        delBtn.addEventListener("click", () => {
          products = products.filter(p => p.id !== product.id);
          saveProducts();
          refreshAll();
        });
        tdDelete.appendChild(delBtn);
        tr.appendChild(tdDelete);

        productTableBody.appendChild(tr);
      });

      summaryText.textContent = `ìƒí’ˆ ${filtered.length}ê°œ (ì „ì²´ ${products.length}ê°œ)`;
    }

    function refreshCategoryFilter() {
      const categories = Array.from(new Set(products.map(p => p.category).filter(Boolean)));
      const currentValue = categoryFilterSelect.value;
      categoryFilterSelect.innerHTML = `<option value="all">ì „ì²´</option>`;
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categoryFilterSelect.appendChild(opt);
      });
      if (categories.includes(currentValue)) {
        categoryFilterSelect.value = currentValue;
      }
    }

    function saveProducts() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
    }

    function loadProducts() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          products = JSON.parse(raw);
        } catch (e) {
          products = [];
        }
      }
    }

    function refreshAll() {
      refreshCategoryFilter();
      renderTable();
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById("clearAllBtn").addEventListener("click", () => {
      if (!confirm("ì •ë§ ì „ì²´ ìƒí’ˆì„ ì‚­ì œí• ê¹Œìš”?")) return;
      products = [];
      saveProducts();
      refreshAll();
    });

    categoryFilterSelect.addEventListener("change", renderTable);
    platformFilterSelect.addEventListener("change", renderTable);

    [naverFeeRateSelect, coupangFeeRateSelect, vatRateSelect, cardFeeRateSelect].forEach(el => {
      el.addEventListener("change", () => {
        calculatePriceGuide();
        renderTable();
      });
    });

    proxyShippingCostInput.addEventListener("input", calculatePriceGuide);

    // ì´ˆê¸°í™”
    loadProducts();
    fetchExchangeRate();
    updateDutyRate();
    updateLclDisplay();
    refreshAll();
  </script>
</body>
</html>
