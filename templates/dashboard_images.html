<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Images - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        h1 { font-size: 24px; color: #fff; }
        .back-btn {
            background: #333;
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
        }
        .back-btn:hover { background: #444; }

        /* Filter */
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            gap: 5px;
            padding: 5px;
            background: #16213e;
            border-radius: 25px;
        }
        .filter-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: transparent;
            color: #888;
            cursor: pointer;
            font-size: 13px;
        }
        .filter-btn.active { background: #3b82f6; color: #fff; }
        .filter-btn:hover:not(.active) { color: #fff; }
        .filter-btn.type-thumb.active { background: #f59e0b; color: #000; }
        .filter-btn.type-scene.active { background: #10b981; color: #fff; }

        /* Image Grid */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .image-card {
            background: #16213e;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333;
            cursor: pointer;
            transition: all 0.2s;
        }
        .image-card:hover { border-color: #3b82f6; transform: translateY(-5px); }
        .image-wrapper {
            aspect-ratio: 16/9;
            overflow: hidden;
            background: #0d1117;
        }
        .image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }
        .image-card:hover .image-wrapper img { transform: scale(1.05); }
        .image-info {
            padding: 15px;
        }
        .image-name {
            font-size: 13px;
            color: #fff;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .image-meta {
            display: flex;
            gap: 8px;
        }
        .image-badge {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }
        .badge-thumb { background: #f59e0b; color: #000; }
        .badge-scene { background: #10b981; color: #fff; }
        .badge-history { background: #3b82f6; color: #fff; }
        .badge-isekai { background: #8b5cf6; color: #fff; }
        .badge-bible { background: #10b981; color: #fff; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            padding: 40px;
            overflow-y: auto;
        }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            max-width: 90vw;
            max-height: 90vh;
            position: relative;
        }
        .modal-content img {
            max-width: 100%;
            max-height: 85vh;
            border-radius: 8px;
        }
        .modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: #fff;
            font-size: 30px;
            cursor: pointer;
        }
        .modal-info {
            margin-top: 15px;
            text-align: center;
            color: #888;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #666;
            grid-column: 1 / -1;
        }

        /* Agent Prompts */
        .agent-prompts {
            background: #16213e;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #333;
            overflow: hidden;
        }
        .prompts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        .prompts-header:hover { background: #1e3a5f; }
        .prompts-header h3 {
            font-size: 14px;
            color: #fff;
            margin: 0;
        }
        .prompts-toggle {
            font-size: 12px;
            color: #666;
            transition: transform 0.3s;
        }
        .prompts-toggle.open { transform: rotate(180deg); }
        .prompts-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .prompts-body.open { max-height: 2000px; }
        .prompts-body-inner { padding: 0 20px 20px 20px; }
        .prompt-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
        }
        .prompt-tab {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid #333;
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .prompt-tab:hover { border-color: #10b981; color: #fff; }
        .prompt-tab.active {
            background: #10b981;
            border-color: #10b981;
            color: #fff;
        }
        .prompt-content { display: block; }
        .prompt-content.hidden { display: none; }
        .prompt-lang {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .prompt-box {
            background: #0d1117;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #333;
        }
        .prompt-label {
            font-size: 12px;
            font-weight: 600;
            color: #888;
            margin-bottom: 10px;
        }
        .prompt-text {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            line-height: 1.6;
            color: #aaa;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        @media (max-width: 768px) {
            .prompt-lang { grid-template-columns: 1fr; }
        }

        /* Stats */
        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #16213e;
            border-radius: 8px;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stat-value { font-size: 20px; font-weight: 700; color: #fff; }
        .stat-label { font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Images (썸네일/씬)</h1>
            <a href="/dashboard" class="back-btn">Back to Dashboard</a>
        </header>

        <!-- Agent Prompts -->
        <div class="agent-prompts">
            <div class="prompts-header" onclick="togglePrompts(this)">
                <h3>Image Agent Prompts</h3>
                <span class="prompts-toggle">▼</span>
            </div>
            <div class="prompts-body">
                <div class="prompts-body-inner">
                    <div class="prompt-tabs">
                        <button class="prompt-tab active" data-tab="thumbnail">Thumbnail Guide</button>
                        <button class="prompt-tab" data-tab="scene">Scene Image Agent</button>
                        <button class="prompt-tab" data-tab="style">Era Style Presets</button>
                    </div>

                    <div class="prompt-content" id="prompt-thumbnail">
                <div class="prompt-lang">
                    <div class="prompt-box" style="grid-column: 1 / -1;">
                        <div class="prompt-label">썸네일 가이드 <span style="font-weight:normal;color:#666;font-size:10px;">(scripts/history_pipeline/agents/image_agent.py)</span></div>
                        <div class="prompt-text" style="max-height:400px;">════════════════════════════════════════
★ 썸네일 구성 요소
════════════════════════════════════════

【텍스트 문구】
- 2줄 구성 (줄바꿈으로 구분)
- 1줄당 7자 이내 권장 (10자 초과 금지)
- 짧고 임팩트 있게
- 질문형 또는 감탄형

예시:
```
18세 왕의
첫 출정
```

```
숨겨진 진실
밝혀지다
```

【이미지 스타일】
- 시대별 스타일 프리셋 적용
- 가장 임팩트 있는 장면 선택
- 인물 클로즈업 또는 극적인 순간
- 시선을 사로잡는 구도

════════════════════════════════════════
★ 썸네일 구도 팁
════════════════════════════════════════

✅ 권장:
- 중앙에 핵심 인물/상징 배치
- 1/3 지점에 텍스트 영역 확보
- 고대비 색상으로 가독성 확보

❌ 피해야 할 것:
- 복잡한 배경
- 작은 글씨
- 여러 인물 동시 등장

════════════════════════════════════════
★ 영문 프롬프트 예시 (Gemini/DALL-E)
════════════════════════════════════════

Portrait of a young Korean king in his late teens,
wearing traditional Goguryeo royal armor,
dramatic rim lighting,
historical painting style,
heroic expression,
Three Kingdoms period Korea,
dynamic composition,
no text, no watermark,
16:9 aspect ratio, high resolution</div>
                    </div>
                </div>
            </div>

            <div class="prompt-content hidden" id="prompt-scene">
                <div class="prompt-lang">
                    <div class="prompt-box" style="grid-column: 1 / -1;">
                        <div class="prompt-label">씬 이미지 에이전트 <span style="font-weight:normal;color:#666;font-size:10px;">(scripts/history_pipeline/script_generator.py - IMAGE_PROMPT_SYSTEM)</span></div>
                        <div class="prompt-text" style="max-height:450px;">════════════════════════════════════════
★ 이미지 프롬프트 규칙 (영문 필수!)
════════════════════════════════════════

【스타일 고정 (역사 다큐멘터리)】
- "Korean historical documentary style"
- "Cinematic wide shot, dramatic lighting"
- "Realistic oil painting style" OR "Historical illustration"
- "Period-accurate Korean costumes and architecture"
- "16:9 aspect ratio, high resolution"
- "No text, no letters, no words, no watermarks"

════════════════════════════════════════
★ 씬 유형별 프롬프트 템플릿
════════════════════════════════════════

【1. 인물 장면 (character_portrait)】
Portrait of [historical figure description],
wearing [period costume],
[expression], dramatic rim lighting,
historical painting style

【2. 전투 장면 (action_scene)】
Epic battle scene, [army description],
[location], dust and smoke,
dynamic composition, cinematic wide shot

【3. 궁정/정치 장면 (narrative_scene)】
Royal court of [dynasty],
[king/officials] in formal attire,
grand throne room, candlelight,
solemn atmosphere

【4. 풍경/지도 장면 (establishing_shot)】
Aerial view of ancient Korea,
[specific location], misty mountains,
traditional architecture, golden hour lighting

【5. 문화재/유물 장면 (cultural_artifact)】
Close-up of [artifact],
museum lighting, detailed texture,
historical significance

════════════════════════════════════════
★ 이미지 개수 계산 (자동)
════════════════════════════════════════

대본 길이 기준 (910자 = 1분):
- 8분 미만: 5개
- 8-10분: 8개
- 10-15분: 11개
- 15분 이상: 12개

════════════════════════════════════════
★ 절대 금지
════════════════════════════════════════
❌ 한글 이미지 프롬프트 (영문만!)
❌ 텍스트/글자 포함 요청
❌ 현대적 요소 (현대 건물, 의상 등)
❌ 부정확한 시대 고증
❌ 폭력적/선정적 묘사

════════════════════════════════════════
★ JSON 출력 형식
════════════════════════════════════════

{
  "scenes": [
    {
      "scene_number": 1,
      "scene_title": "씬 제목 (한글)",
      "narration_preview": "이 씬의 나레이션 첫 50자...",
      "image_prompt": "English image prompt..."
    }
  ],
  "thumbnail": {
    "image_prompt": "English thumbnail prompt..."
  }
}</div>
                    </div>
                </div>
            </div>

            <div class="prompt-content hidden" id="prompt-style">
                <div class="prompt-lang">
                    <div class="prompt-box" style="grid-column: 1 / -1;">
                        <div class="prompt-label">시대별 스타일 프리셋 <span style="font-weight:normal;color:#666;font-size:10px;">(ERA_STYLE_PRESETS)</span></div>
                        <div class="prompt-text" style="max-height:450px;">════════════════════════════════════════
★ 시대별 스타일 프리셋
════════════════════════════════════════

【고조선 (Bronze Age)】
- style: mythological, ancient Korean, bronze age aesthetic
- color: earth tones, bronze, deep blue
- mood: mysterious, legendary, primordial

【삼국시대 (Three Kingdoms)】
- style: Three Kingdoms period Korea, traditional East Asian art
- color: gold, red, forest green
- mood: heroic, dynamic, martial

【통일신라 (Unified Silla)】
- style: Unified Silla period, Buddhist influenced art
- color: gold, jade green, royal purple
- mood: refined, spiritual, prosperous

【발해 (Balhae)】
- style: Balhae kingdom, northern Korean aesthetics
- color: dark blue, white, silver
- mood: vast, powerful, frontier

【고려 (Goryeo)】
- style: Goryeo dynasty, Buddhist and aristocratic
- color: celadon green, gold, deep red
- mood: elegant, spiritual, cultured

【조선 전기 (Early Joseon)】
- style: early Joseon dynasty, Confucian aesthetics
- color: white, black, muted colors
- mood: austere, dignified, scholarly

【조선 중기 (Mid Joseon)】
- style: mid Joseon dynasty, classical Korean painting
- color: ink wash, subtle colors
- mood: contemplative, refined, literary

【조선 후기 (Late Joseon)】
- style: late Joseon, folk painting (minhwa) style
- color: vibrant primary colors
- mood: lively, expressive, populist

【대한제국 (Korean Empire)】
- style: Korean Empire period, East-West fusion
- color: imperial yellow, western influences
- mood: transitional, modernizing, proud

【일제강점기 (Colonial Period)】
- style: Japanese colonial period, historical photography style
- color: sepia, muted, somber
- mood: resistant, sorrowful, enduring

【현대 대한민국 (Modern Korea)】
- style: modern Korea, documentary photography
- color: realistic, full color
- mood: dynamic, progressive, hopeful

════════════════════════════════════════
★ 프롬프트에 시대 스타일 적용 예시
════════════════════════════════════════

원본: "A Korean king giving orders to his generals"

삼국시대 적용:
"Three Kingdoms period Korea, traditional East Asian art,
heroic, dynamic, martial atmosphere,
gold, red, forest green color palette,
A Korean king giving orders to his generals,
no text, no watermark, no modern elements,
historically accurate"</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-value" id="stat-total">0</span>
                <span class="stat-label">Total</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="stat-thumb">0</span>
                <span class="stat-label">Thumbnails</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="stat-scene">0</span>
                <span class="stat-label">Scenes</span>
            </div>
        </div>

        <div class="filter-bar">
            <div class="filter-group">
                <button class="filter-btn active" data-filter="pipeline" data-value="all">All</button>
                <button class="filter-btn" data-filter="pipeline" data-value="history">History</button>
                <button class="filter-btn" data-filter="pipeline" data-value="isekai">Isekai</button>
                <button class="filter-btn" data-filter="pipeline" data-value="bible">Bible</button>
            </div>
            <div class="filter-group">
                <button class="filter-btn type-thumb" data-filter="type" data-value="all">All Types</button>
                <button class="filter-btn type-thumb" data-filter="type" data-value="thumb">Thumbnails</button>
                <button class="filter-btn type-scene" data-filter="type" data-value="scene">Scenes</button>
            </div>
        </div>

        <div class="image-grid" id="image-grid">
            <div class="empty-state">Loading...</div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <img id="modal-img" src="" alt="">
            <div class="modal-info" id="modal-info"></div>
        </div>
    </div>

    <script>
        let allImages = [];
        let filters = { pipeline: 'all', type: 'all' };

        async function fetchImages() {
            try {
                const res = await fetch('/api/dashboard/images?limit=200');
                const data = await res.json();
                allImages = data.images || [];
                updateStats();
                renderImages();
            } catch (e) {
                document.getElementById('image-grid').innerHTML = '<div class="empty-state">Failed to load images</div>';
            }
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = allImages.length;
            document.getElementById('stat-thumb').textContent = allImages.filter(i => i.type === 'thumb').length;
            document.getElementById('stat-scene').textContent = allImages.filter(i => i.type === 'scene').length;
        }

        function renderImages() {
            const container = document.getElementById('image-grid');
            let images = allImages;

            if (filters.pipeline !== 'all') {
                images = images.filter(i => i.pipeline === filters.pipeline);
            }
            if (filters.type !== 'all') {
                images = images.filter(i => i.type === filters.type);
            }

            if (images.length === 0) {
                container.innerHTML = '<div class="empty-state">No images found</div>';
                return;
            }

            container.innerHTML = images.map(img => `
                <div class="image-card" onclick="viewImage('${img.url}', '${img.name}')">
                    <div class="image-wrapper">
                        <img src="${img.url}" alt="${img.name}" loading="lazy">
                    </div>
                    <div class="image-info">
                        <div class="image-name">${img.name}</div>
                        <div class="image-meta">
                            <span class="image-badge badge-${img.type}">${img.type === 'thumb' ? 'Thumbnail' : 'Scene'}</span>
                            <span class="image-badge badge-${img.pipeline}">${img.pipeline}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function viewImage(url, name) {
            document.getElementById('modal-img').src = url;
            document.getElementById('modal-info').textContent = name;
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const filterType = btn.dataset.filter;
                const value = btn.dataset.value;

                // Update active state within same group
                document.querySelectorAll(`.filter-btn[data-filter="${filterType}"]`).forEach(b => {
                    b.classList.remove('active');
                });
                btn.classList.add('active');

                filters[filterType] = value;
                renderImages();
            });
        });

        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') closeModal();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        fetchImages();

        // Tab switching for agent prompts
        document.querySelectorAll('.prompt-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.prompt-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.prompt-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`prompt-${tabName}`).classList.remove('hidden');
            });
        });

        // Toggle prompts
        function togglePrompts(header) {
            const body = header.nextElementSibling;
            const toggle = header.querySelector('.prompts-toggle');
            body.classList.toggle('open');
            toggle.classList.toggle('open');
        }
    </script>
</body>
</html>
