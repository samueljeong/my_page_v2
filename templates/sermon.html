<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì„¤êµ ë„ì›€ í˜ì´ì§€</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f5f5f5; }
    .page-wrap { display: flex; gap: 1rem; padding: 1rem; height: 100vh; box-sizing: border-box; }
    .left-col { width: 360px; display: flex; flex-direction: column; gap: .75rem; }
    .right-col { flex: 1; display: flex; flex-direction: column; gap: .75rem; min-width: 0; }
    .box { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: .75rem; }
    .label-row { display: flex; justify-content: space-between; align-items: center; gap: .5rem; margin-bottom: .35rem; }
    .label { font-weight: 600; }
    input[type="text"], input[type="date"], select { width: 100%; padding: .35rem .5rem; box-sizing: border-box; }
    textarea { width: 100%; min-height: 80px; resize: vertical; box-sizing: border-box; font-family: inherit; line-height: 1.4; }
    .btn-row { display: flex; gap: .5rem; flex-wrap: wrap; }
    button { padding: .35rem .6rem; border: 1px solid #ccc; background: #f0f0f0; border-radius: 6px; cursor: pointer; }
    button:hover { background: #e0e0e0; }
    .storage-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: .25rem 0; gap: .5rem; }
    .storage-item:last-child { border-bottom: none; }
    .storage-actions button { font-size: .7rem; padding: .25rem .45rem; }
    .toggle-header { display: flex; justify-content: space-between; align-items: center; }
    .copy-btn { font-size: .7rem; padding: .2rem .5rem; background: #fff; }
    .status-bar { position: fixed; bottom: 10px; right: 10px; background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: .4rem .7rem; font-size: .8rem; box-shadow: 0 2px 6px rgba(0,0,0,.08); display: none; }
    .guide-tab-active { background: #dfe6ff; border-color: #b5c6ff; }
    textarea.autosize { overflow: hidden; }
  </style>
</head>
<body>
  <div class="page-wrap">
    <!-- ì™¼ìª½ -->
    <div class="left-col">
      <!-- ë‚ ì§œ -->
      <div class="box">
        <div class="label-row">
          <label class="label" for="sermon-date">ë‚ ì§œ</label>
          <input type="date" id="sermon-date" style="max-width: 160px;">
        </div>
      </div>

      <!-- ì¹´í…Œê³ ë¦¬ -->
      <div class="box">
        <label class="label" for="sermon-category">ì„¤êµ ì¹´í…Œê³ ë¦¬</label>
        <select id="sermon-category">
          <option value="dawn">ìƒˆë²½ì„¤êµ</option>
          <option value="wednesday">ìˆ˜ìš”ì„±ê²½ê³µë¶€</option>
          <option value="friday">ê¸ˆìš”ê¸°ë„íšŒ</option>
          <option value="youth">ì²­ë…„ë¶€</option>
          <option value="teen">ì²­ì†Œë…„ë¶€</option>
          <option value="women">ì—¬ì„ êµíšŒ</option>
          <option value="men">ë‚¨ì„ êµíšŒ</option>
          <option value="etc">ê¸°íƒ€</option>
        </select>
      </div>

      <!-- ì„±ê²½êµ¬ì ˆ -->
      <div class="box">
        <label class="label">ì„±ê²½êµ¬ì ˆ</label>
        <input type="text" id="sermon-ref" placeholder="ì˜ˆ) ì‹œ 78:1-8">
      </div>

      <!-- ì„±ê²½ ë³¸ë¬¸ -->
      <div class="box">
        <label class="label">ì„±ê²½ ë³¸ë¬¸</label>
        <textarea id="sermon-text" placeholder="ë³¸ë¬¸ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
      </div>

      <!-- ì‹¤í–‰ ë²„íŠ¼ -->
      <div class="box">
        <div class="btn-row">
          <button id="btn-analyze">ë³¸ë¬¸ ë¶„ì„</button>
          <button id="btn-prompt">ì„¤êµ ì œì‘ í”„ë¡¬í¬íŠ¸</button>
        </div>
      </div>

      <!-- ì €ì¥ ê³µê°„ -->
      <div class="box">
        <label class="label">ì €ì¥ëœ ì„¤êµ ìë£Œ</label>
        <div class="btn-row" style="margin-bottom: .5rem;">
          <button id="btn-save">í˜„ì¬ ë‚´ìš© ì €ì¥</button>
        </div>
        <div id="saved-list"></div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ -->
    <div class="right-col">
      <!-- ì§€ì¹¨ ì˜ì—­ -->
      <div class="box" id="guide-box">
        <div class="toggle-header">
          <span class="label">ì§€ì¹¨ ì˜ì—­</span>
          <button id="toggle-guides">ë‹«ê¸°</button>
        </div>
        <div class="btn-row" style="margin: .5rem 0;">
          <button id="save-guide">ì§€ì¹¨ ì €ì¥</button>
          <button id="tab-guide-analysis" class="guide-tab-active">ë³¸ë¬¸ ë¶„ì„ ì§€ì¹¨</button>
          <button id="tab-guide-prompt">ì„¤êµë¬¸ ì œì‘ í”„ë¡¬í¬íŠ¸</button>
        </div>
        <textarea id="guide-text" class="autosize" style="min-height: 90px;" placeholder="ì„ íƒí•œ ì§€ì¹¨ ìœ í˜•ì˜ ë‚´ìš©ì„ ì‘ì„±í•©ë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ë§ˆë‹¤ ë”°ë¡œ ì €ì¥ë©ë‹ˆë‹¤."></textarea>
      </div>

      <!-- ë³¸ë¬¸ ë¶„ì„ ê²°ê³¼ -->
      <div class="box">
        <div class="toggle-header">
          <label class="label">ë³¸ë¬¸ ë¶„ì„</label>
          <button class="copy-btn" data-copy="analysis-box">ë³µì‚¬</button>
        </div>
        <textarea id="analysis-box" class="autosize" style="min-height: 140px;" placeholder="ë³¸ë¬¸ ë¶„ì„ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤. ..."></textarea>
      </div>

      <!-- ì„¤êµë¬¸ ì œì‘ í”„ë¡¬í¬íŠ¸ ê²°ê³¼ -->
      <div class="box">
        <div class="toggle-header">
          <label class="label">ì„¤êµë¬¸ ì œì‘ í”„ë¡¬í¬íŠ¸</label>
          <button class="copy-btn" data-copy="sermon-prompt-box">ë³µì‚¬</button>
        </div>
        <textarea id="sermon-prompt-box" class="autosize" style="min-height: 140px;" placeholder="GPTì— ë˜ì§ˆ í”„ë¡¬í¬íŠ¸ë¥¼ ..."></textarea>
      </div>
    </div>
  </div>

  <!-- ì§„í–‰ ìƒíƒœ -->
  <div id="status-bar" class="status-bar">GPTë¡œ ì‘ì—… ì¤‘...</div>

<!-- Firebase SDK ì¶”ê°€ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  
  <script>
  // ===== Firebase ì´ˆê¸°í™” =====
  const firebaseConfig = {
    apiKey: "AIzaSyBacmJDk-PG5FaoqnXV8Rg3P__AKOS2vu4",
    authDomain: "my-sermon-guides.firebaseapp.com",
    projectId: "my-sermon-guides",
    storageBucket: "my-sermon-guides.firebasestorage.app",
    messagingSenderId: "539520456089",
    appId: "1:539520456089:web:d6aceb7838baa89e70af08",
    measurementId: "G-KWN8TH7Z26"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  
  // ê³ ìœ  ì‚¬ìš©ì ì½”ë“œ (ì›í•˜ëŠ” ëŒ€ë¡œ ë³€ê²½ ê°€ëŠ¥)
  const USER_CODE = 'samuel123';
  const PAGE_NAME = 'sermon';

  // ===== ê¸°ì¡´ ë³€ìˆ˜ë“¤ =====
  const categorySelect = document.getElementById("category-select");
  const guideTypeButtons = document.querySelectorAll(".guide-type-btn");
  const guideTextArea = document.getElementById("guide-text");
  const statusMsg = document.getElementById("status-msg");

  let currentGuideType = "analysis";

  function getGuideKey(category, type) {
    return `sermon-guide-${category}-${type}`;
  }

  function showStatus(msg) {
    statusMsg.textContent = msg;
    statusMsg.style.display = "block";
  }

  function hideStatus() {
    statusMsg.style.display = "none";
  }

  // ===== Firebase í•¨ìˆ˜ë“¤ =====
  
  // Firebaseì—ì„œ ëª¨ë“  ì§€ì¹¨ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadFromFirebase() {
    try {
      const snapshot = await db
        .collection('users')
        .doc(USER_CODE)
        .collection(PAGE_NAME)
        .get();
      
      let loadedCount = 0;
      if (!snapshot.empty) {
        snapshot.forEach(doc => {
          const key = doc.id;
          const value = doc.data().value;
          localStorage.setItem(key, value);
          loadedCount++;
        });
        console.log(`âœ… Firebaseì—ì„œ ${loadedCount}ê°œ ì§€ì¹¨ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!`);
        return true;
      } else {
        console.log('Firebaseì— ì €ì¥ëœ ì§€ì¹¨ì´ ì—†ìŠµë‹ˆë‹¤.');
        return false;
      }
    } catch (err) {
      console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', err);
      return false;
    }
  }

  // Firebaseì— ì§€ì¹¨ ì €ì¥
  async function saveToFirebase(key, value) {
    try {
      await db
        .collection('users')
        .doc(USER_CODE)
        .collection(PAGE_NAME)
        .doc(key)
        .set({
          value: value,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      return true;
    } catch (err) {
      console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', err);
      return false;
    }
  }

  // ===== í™”ë©´ ì—…ë°ì´íŠ¸ =====
  
  function loadCurrentGuide() {
    const cat = categorySelect.value;
    const key = getGuideKey(cat, currentGuideType);
    const stored = localStorage.getItem(key);
    guideTextArea.value = stored || "";
  }

  categorySelect.addEventListener("change", loadCurrentGuide);

  guideTypeButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      guideTypeButtons.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      currentGuideType = btn.dataset.type;
      loadCurrentGuide();
    });
  });

  // ===== ì§€ì¹¨ ì €ì¥ ë²„íŠ¼ =====
  
  document.getElementById("save-guide").addEventListener("click", async () => {
    const cat = categorySelect.value;
    const key = getGuideKey(cat, currentGuideType);
    const value = guideTextArea.value;

    // 1. localStorage ì €ì¥ (ë¹ ë¥¸ ë¡œì»¬ ì ‘ê·¼)
    localStorage.setItem(key, value);

    // 2. Firebase ì €ì¥ (í´ë¼ìš°ë“œ ë™ê¸°í™”)
    showStatus("ğŸ’¾ ì €ì¥ ì¤‘...");
    const success = await saveToFirebase(key, value);

    if (success) {
      showStatus("âœ… ì§€ì¹¨ì´ ì €ì¥ë˜ê³  í´ë¼ìš°ë“œì— ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
    } else {
      showStatus("âš ï¸ ë¡œì»¬ì—ë§Œ ì €ì¥ë¨ (í´ë¼ìš°ë“œ ë™ê¸°í™” ì‹¤íŒ¨)");
    }

    setTimeout(hideStatus, 2000);
  });

  // ===== í…ŒìŠ¤íŠ¸ ë²„íŠ¼ =====
  
  document.getElementById("test-guide").addEventListener("click", async () => {
    const cat = categorySelect.value;
    const key = getGuideKey(cat, currentGuideType);
    const storedGuide = localStorage.getItem(key) || "";

    if (!storedGuide.trim()) {
      alert("ë¨¼ì € ì§€ì¹¨ì„ ì‘ì„±í•˜ê³  ì €ì¥í•˜ì„¸ìš”.");
      return;
    }

    const sampleText = "ì—¬í˜¸ì™€ëŠ” ë‚˜ì˜ ëª©ìì‹œë‹ˆ ë‚´ê²Œ ë¶€ì¡±í•¨ì´ ì—†ìœ¼ë¦¬ë¡œë‹¤.";
    showStatus("ğŸ¤– GPTì—ê²Œ í…ŒìŠ¤íŠ¸ ìš”ì²­ ì¤‘...");

    try {
      const response = await fetch("/api/sermon/test-guide", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          category: cat,
          guide_type: currentGuideType,
          guide: storedGuide,
          sample_text: sampleText,
        }),
      });

      const data = await response.json();

      if (data.ok) {
        alert(`âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ!\n\nê²°ê³¼:\n${data.result}`);
        hideStatus();
      } else {
        alert(`âŒ ì˜¤ë¥˜ ë°œìƒ:\n${data.error}`);
        hideStatus();
      }
    } catch (err) {
      alert(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:\n${err.message}`);
      hideStatus();
    }
  });

  // ===== ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° =====
  
  // ë‚´ë³´ë‚´ê¸°
  document.getElementById("export-guides").addEventListener("click", () => {
    const guides = {};
    const categories = ["dawn", "wednesday", "friday", "youth"];
    const types = ["analysis", "prompt"];

    categories.forEach((cat) => {
      types.forEach((type) => {
        const key = getGuideKey(cat, type);
        guides[key] = localStorage.getItem(key) || "";
      });
    });

    const blob = new Blob([JSON.stringify(guides, null, 2)], {
      type: "application/json",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "sermon-guides-backup.json";
    a.click();

    alert("âœ… ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!\n\nì°¸ê³ : Firebaseì— ìë™ ì €ì¥ë˜ë¯€ë¡œ ë°±ì—…ì€ ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤.");
  });

  // ê°€ì ¸ì˜¤ê¸°
  document.getElementById("import-guides").addEventListener("click", () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";

    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (evt) => {
        try {
          const guides = JSON.parse(evt.target.result);
          
          // localStorageì— ì €ì¥
          for (const [key, value] of Object.entries(guides)) {
            localStorage.setItem(key, value);
          }

          // Firebaseì—ë„ ì—…ë¡œë“œ
          showStatus("â˜ï¸ Firebaseì— ì—…ë¡œë“œ ì¤‘...");
          let uploadCount = 0;
          for (const [key, value] of Object.entries(guides)) {
            const success = await saveToFirebase(key, value);
            if (success) uploadCount++;
          }

          alert(`âœ… ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!\n\në¡œì»¬: ${Object.keys(guides).length}ê°œ\nFirebase: ${uploadCount}ê°œ`);
          loadCurrentGuide();
          hideStatus();
        } catch (err) {
          alert(`âŒ JSON íŒŒì¼ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤:\n${err.message}`);
        }
      };
      reader.readAsText(file);
    };

    input.click();
  });

  // ===== Firebase ë™ê¸°í™” ë²„íŠ¼ =====
  
  // "í´ë¼ìš°ë“œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ ì¶”ê°€
  document.getElementById("sync-from-cloud")?.addEventListener("click", async () => {
    if (!confirm("ë¡œì»¬ ì§€ì¹¨ì„ í´ë¼ìš°ë“œ ì§€ì¹¨ìœ¼ë¡œ ë®ì–´ì”Œìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
    showStatus("â˜ï¸ í´ë¼ìš°ë“œì—ì„œ ë‹¤ìš´ë¡œë“œ ì¤‘...");
    const success = await loadFromFirebase();
    
    if (success) {
      loadCurrentGuide();
      showStatus("âœ… í´ë¼ìš°ë“œ ì§€ì¹¨ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!");
    } else {
      showStatus("âš ï¸ í´ë¼ìš°ë“œì— ì €ì¥ëœ ì§€ì¹¨ì´ ì—†ìŠµë‹ˆë‹¤.");
    }
    
    setTimeout(hideStatus, 2000);
  });

  // ===== í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” =====
  
  document.addEventListener("DOMContentLoaded", async () => {
    // Firebaseì—ì„œ ìµœì‹  ì§€ì¹¨ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œë„
    showStatus("â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™” ì¤‘...");
    await loadFromFirebase();
    hideStatus();
    
    // í™”ë©´ì— í˜„ì¬ ì§€ì¹¨ í‘œì‹œ
    loadCurrentGuide();
  });
  </script>
</body>
</html>
