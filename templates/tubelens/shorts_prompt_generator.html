<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shorts Prompt Generator - TubeLens</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%23FF0000' width='32' height='32' rx='6'/><text x='16' y='22' font-size='16' fill='white' text-anchor='middle' font-weight='bold'>T</text></svg>">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 32px; background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-icon {
      width: 40px; height: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
    }
    .header-left h1 {
      font-size: 1.4rem; font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .header-badge {
      font-size: 0.7rem; color: #fff; padding: 4px 10px; border-radius: 20px; font-weight: 600;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .header-right { display: flex; gap: 10px; }
    .header-btn {
      padding: 10px 20px; background: #f5f7fa; color: #333; text-decoration: none;
      border-radius: 10px; font-size: 0.85rem; font-weight: 500; transition: all 0.3s;
    }
    .header-btn:hover { background: #e1e5eb; }
    .header-btn.home { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
    .main-container { max-width: 1100px; margin: 0 auto; padding: 40px 20px; }
    .hero { text-align: center; margin-bottom: 40px; color: #fff; }
    .hero h2 { font-size: 2rem; font-weight: 700; margin-bottom: 12px; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    .hero p { font-size: 1.1rem; opacity: 0.9; }
    .tab-container {
      background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
      border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); overflow: hidden;
    }
    .tabs { display: flex; background: #f5f7fa; border-bottom: 1px solid #e1e5eb; }
    .tab {
      flex: 1; padding: 18px; font-size: 0.95rem; font-weight: 600; color: #666;
      background: transparent; border: none; cursor: pointer; transition: all 0.3s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .tab:hover { color: #333; background: rgba(255,255,255,0.5); }
    .tab.active { color: #667eea; background: #fff; position: relative; }
    .tab.active::after {
      content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .tab-content { display: none; padding: 28px; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .upload-zone {
      border: 2px dashed #d1d5db; border-radius: 16px; padding: 50px 30px; text-align: center;
      cursor: pointer; transition: all 0.3s; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    .upload-zone:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 10px 40px rgba(102,126,234,0.15); }
    .upload-zone.dragover { border-color: #667eea; background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%); }
    .upload-icon {
      width: 80px; height: 80px; margin: 0 auto 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem;
      box-shadow: 0 10px 30px rgba(102,126,234,0.3);
    }
    .upload-text h3 { font-size: 1.2rem; color: #333; margin-bottom: 8px; }
    .upload-text p { color: #666; font-size: 0.9rem; margin-bottom: 4px; }
    .upload-text .formats { color: #999; font-size: 0.8rem; }
    .upload-zone input[type="file"] { display: none; }
    .preview-container { display: none; padding: 20px; }
    .preview-container.active { display: block; }
    .preview-video, .preview-image { max-width: 100%; max-height: 300px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .file-info { margin-top: 12px; display: flex; align-items: center; justify-content: center; gap: 12px; }
    .file-name { color: #333; font-weight: 500; }
    .btn-change { padding: 8px 16px; background: #f1f5f9; color: #666; border: none; border-radius: 8px; font-size: 0.85rem; cursor: pointer; }
    .options-section { margin-top: 24px; }
    .options-title { font-size: 0.9rem; font-weight: 600; color: #333; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    .option-card { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 10px; padding: 14px; }
    .option-card:hover { border-color: #667eea; }
    .option-card label { display: block; font-size: 0.75rem; font-weight: 600; color: #64748b; margin-bottom: 6px; text-transform: uppercase; }
    .option-card select, .option-card input {
      width: 100%; padding: 10px; font-size: 0.9rem; border: 1px solid #e2e8f0; border-radius: 8px; background: #fff;
    }
    .option-card select:focus, .option-card input:focus { outline: none; border-color: #667eea; }
    .btn-primary {
      width: 100%; padding: 16px; margin-top: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px;
      box-shadow: 0 4px 15px rgba(102,126,234,0.3);
    }
    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102,126,234,0.4); }
    .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }
    .btn-secondary { background: #1e293b; color: #fff; border: none; padding: 10px 20px; border-radius: 10px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .btn-secondary:hover { background: #334155; }
    .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .progress-panel { background: #fff; border-radius: 16px; padding: 28px; margin-top: 20px; display: none; }
    .progress-panel.active { display: block; }
    .progress-steps { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .progress-step { display: flex; flex-direction: column; align-items: center; flex: 1; position: relative; }
    .progress-step::before { content: ''; position: absolute; top: 15px; left: 50%; width: 100%; height: 2px; background: #e2e8f0; }
    .progress-step:last-child::before { display: none; }
    .progress-step .step-icon { width: 32px; height: 32px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; position: relative; z-index: 1; }
    .progress-step.active .step-icon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; animation: pulse 1.5s infinite; }
    .progress-step.completed .step-icon { background: #10b981; color: #fff; }
    @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(102,126,234,0.4); } 50% { box-shadow: 0 0 0 10px rgba(102,126,234,0); } }
    .progress-step .step-label { font-size: 0.7rem; color: #64748b; margin-top: 8px; }
    .progress-bar-wrap { background: #e2e8f0; border-radius: 10px; height: 8px; overflow: hidden; }
    .progress-bar { height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; width: 0%; transition: width 0.5s ease; }
    .progress-text { font-size: 0.85rem; color: #64748b; text-align: center; margin-top: 10px; }
    .results-panel { background: #fff; border-radius: 20px; padding: 28px; margin-top: 20px; display: none; }
    .results-panel.active { display: block; animation: fadeIn 0.3s ease; }
    .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e2e8f0; flex-wrap: wrap; gap: 12px; }
    .results-title { display: flex; align-items: center; gap: 12px; }
    .results-title h3 { font-size: 1.2rem; color: #1e293b; }
    .results-meta { display: flex; gap: 10px; margin-top: 6px; }
    .results-meta span { font-size: 0.8rem; color: #64748b; background: #f1f5f9; padding: 4px 10px; border-radius: 6px; }
    .error-panel { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border: 1px solid #fca5a5; border-radius: 12px; padding: 14px 18px; margin-top: 16px; color: #b91c1c; display: none; align-items: center; gap: 10px; }
    .error-panel.active { display: flex; }
    /* Scene Cards */
    .scene-list { display: flex; flex-direction: column; gap: 20px; }
    .scene-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 14px; padding: 20px; transition: all 0.2s; }
    .scene-card:hover { border-color: #667eea; box-shadow: 0 4px 20px rgba(102,126,234,0.1); }
    .scene-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .scene-badge { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 6px 14px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; }
    .scene-time { color: #64748b; font-size: 0.85rem; }
    .scene-analysis { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px; }
    .analysis-field { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px; }
    .analysis-field label { display: block; font-size: 0.7rem; font-weight: 600; color: #667eea; margin-bottom: 6px; text-transform: uppercase; }
    .analysis-field input, .analysis-field textarea {
      width: 100%; padding: 8px; font-size: 0.85rem; border: 1px solid #e2e8f0; border-radius: 6px; resize: vertical;
    }
    .analysis-field input:focus, .analysis-field textarea:focus { outline: none; border-color: #667eea; }
    .prompt-box { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px; }
    .prompt-box label { display: block; font-size: 0.75rem; font-weight: 600; color: #333; margin-bottom: 8px; }
    .prompt-box textarea { width: 100%; min-height: 80px; padding: 10px; font-size: 0.9rem; border: 1px solid #e2e8f0; border-radius: 8px; resize: vertical; line-height: 1.5; }
    .prompt-box textarea:focus { outline: none; border-color: #667eea; }
    .scene-actions { display: flex; gap: 8px; margin-top: 12px; justify-content: flex-end; }
    .btn-small { padding: 8px 14px; font-size: 0.8rem; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .btn-copy { background: #e2e8f0; color: #475569; }
    .btn-copy:hover { background: #cbd5e1; }
    .btn-copy.copied { background: #10b981; color: #fff; }
    .btn-regenerate { background: #fef3c7; color: #92400e; }
    .btn-regenerate:hover { background: #fde68a; }
    /* Character Section */
    .character-section { margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #f0f7ff 0%, #f5f3ff 100%); border: 2px solid #e0e7ff; border-radius: 14px; }
    .character-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .character-header h4 { font-size: 1rem; color: #1e293b; display: flex; align-items: center; gap: 8px; }
    .saved-characters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    .character-chip {
      padding: 8px 14px; background: #fff; border: 1px solid #e2e8f0; border-radius: 20px;
      font-size: 0.8rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;
    }
    .character-chip:hover { border-color: #667eea; background: #f0f7ff; }
    .character-chip.active { background: #667eea; color: #fff; border-color: #667eea; }
    .character-chip .delete-char { font-size: 0.7rem; opacity: 0.7; }
    .character-chip .delete-char:hover { opacity: 1; }
    .character-form { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .character-form .full-width { grid-column: 1 / -1; }
    /* Generated Images & Video */
    .generated-section { margin-top: 24px; padding-top: 20px; border-top: 1px solid #e2e8f0; display: none; }
    .generated-section.active { display: block; }
    .generated-section h4 { font-size: 1rem; color: #1e293b; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
    .images-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
    .image-card { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 9/16; background: #f1f5f9; }
    .image-card img { width: 100%; height: 100%; object-fit: cover; }
    .image-card .overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 6px; background: linear-gradient(transparent, rgba(0,0,0,0.7)); color: white; font-size: 0.7rem; }
    .image-card.failed { display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fee2e2; color: #b91c1c; font-size: 0.7rem; padding: 8px; text-align: center; }
    .video-result { text-align: center; margin-top: 20px; }
    .video-result video { max-width: 280px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
    .video-result .download-btn { margin-top: 14px; display: inline-flex; background: #10b981; color: #fff; padding: 12px 24px; border-radius: 10px; text-decoration: none; font-weight: 500; align-items: center; gap: 8px; }
    .video-result .download-btn:hover { background: #059669; }
    /* Direct Create Tab */
    .direct-create-form { display: flex; flex-direction: column; gap: 16px; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-size: 0.8rem; font-weight: 600; color: #333; margin-bottom: 6px; }
    .form-group input, .form-group textarea, .form-group select {
      padding: 12px; font-size: 0.9rem; border: 2px solid #e2e8f0; border-radius: 10px;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #667eea; }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .scene-count-selector { display: flex; align-items: center; gap: 12px; }
    .scene-count-btn { width: 36px; height: 36px; border: none; background: #e2e8f0; border-radius: 8px; font-size: 1.2rem; cursor: pointer; }
    .scene-count-btn:hover { background: #cbd5e1; }
    .scene-count-value { font-size: 1.5rem; font-weight: 700; color: #667eea; min-width: 40px; text-align: center; }
    @media (max-width: 768px) {
      .main-container { padding: 20px 16px; }
      .hero h2 { font-size: 1.5rem; }
      .tab-content { padding: 20px; }
      .scene-analysis { grid-template-columns: 1fr; }
      .character-form { grid-template-columns: 1fr; }
      .results-header { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="logo">
        <div class="logo-icon">ğŸ¬</div>
        <h1>Shorts Prompt Generator</h1>
      </div>
      <span class="header-badge">GPT-5.1 Powered</span>
    </div>
    <div class="header-right">
      <a href="/tubelens" class="header-btn">TubeLens</a>
      <a href="/" class="header-btn home">Home</a>
    </div>
  </header>

  <main class="main-container">
    <section class="hero">
      <h2>AI ì‡¼ì¸  ì˜ìƒ ì œì‘</h2>
      <p>ì˜ìƒ ë¶„ì„ ë˜ëŠ” ì§ì ‘ í”„ë¡¬í”„íŠ¸ë¡œ ì‡¼ì¸ ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
    </section>

    <div class="tab-container">
      <div class="tabs">
        <button class="tab active" data-tab="video">ğŸ¥ ì˜ìƒ ë¶„ì„</button>
        <button class="tab" data-tab="image">ğŸ–¼ï¸ ì´ë¯¸ì§€ ë¶„ì„</button>
        <button class="tab" data-tab="direct">âœ¨ ì§ì ‘ ìƒì„±</button>
      </div>

      <!-- Video Analysis Tab -->
      <div class="tab-content active" id="video-tab">
        <div class="upload-zone" id="video-drop-zone">
          <input type="file" id="video-upload" accept="video/*">
          <div id="video-upload-content">
            <div class="upload-icon">ğŸ¥</div>
            <div class="upload-text">
              <h3>ì˜ìƒ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</h3>
              <p>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
              <p class="formats">MP4, WebM, MOV Â· ìµœëŒ€ 100MB</p>
            </div>
          </div>
          <div class="preview-container" id="video-preview-container">
            <video id="preview-video" class="preview-video" controls></video>
            <div class="file-info">
              <span class="file-name" id="video-file-name"></span>
              <button class="btn-change" id="btn-change-video">ë³€ê²½</button>
            </div>
          </div>
        </div>
        <div class="options-section">
          <div class="options-title"><span>âš™ï¸</span> ë¶„ì„ ì˜µì…˜</div>
          <div class="options-grid">
            <div class="option-card">
              <label>ë¶„ì„ ëª¨ë“œ</label>
              <select id="mode">
                <option value="scene" selected>ì”¬ ê¸°ë°˜ (ê¶Œì¥)</option>
                <option value="interval">ì‹œê°„ ê¸°ë°˜</option>
              </select>
            </div>
            <div class="option-card" id="threshold-group">
              <label>ì”¬ ê°ì§€ ë¯¼ê°ë„</label>
              <select id="threshold">
                <option value="0.2">ë†’ìŒ (0.2)</option>
                <option value="0.3" selected>ë³´í†µ (0.3)</option>
                <option value="0.4">ë‚®ìŒ (0.4)</option>
              </select>
            </div>
            <div class="option-card" id="interval-group" style="display:none;">
              <label>í”„ë ˆì„ ê°„ê²©</label>
              <select id="interval">
                <option value="3">3ì´ˆ</option>
                <option value="5" selected>5ì´ˆ</option>
                <option value="10">10ì´ˆ</option>
              </select>
            </div>
          </div>
        </div>
        <button id="btn-analyze" class="btn-primary" disabled>
          <span class="spinner" id="video-spinner"></span>
          <span id="btn-analyze-text">GPT-5.1ë¡œ ë¶„ì„ ì‹œì‘</span>
        </button>
      </div>

      <!-- Image Analysis Tab -->
      <div class="tab-content" id="image-tab">
        <div class="upload-zone" id="image-drop-zone">
          <input type="file" id="image-upload" accept="image/*">
          <div id="image-upload-content">
            <div class="upload-icon">ğŸ–¼ï¸</div>
            <div class="upload-text">
              <h3>ì´ë¯¸ì§€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</h3>
              <p>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
              <p class="formats">PNG, JPG, WebP ë“±</p>
            </div>
          </div>
          <div class="preview-container" id="image-preview-container">
            <img id="preview-image" class="preview-image">
            <div class="file-info">
              <span class="file-name" id="image-file-name"></span>
              <button class="btn-change" id="btn-change-image">ë³€ê²½</button>
            </div>
          </div>
        </div>
        <p style="margin-top:16px;color:#64748b;font-size:0.9rem;">ğŸ’¡ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ ìƒì„¸í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
        <button id="btn-analyze-image" class="btn-primary" disabled>
          <span class="spinner" id="image-spinner"></span>
          <span id="btn-analyze-image-text">ì´ë¯¸ì§€ ë¶„ì„</span>
        </button>
      </div>

      <!-- Direct Create Tab -->
      <div class="tab-content" id="direct-tab">
        <div class="character-section" style="margin-top:0;">
          <div class="character-header">
            <h4>ğŸ­ ë‚´ ìºë¦­í„°</h4>
            <button class="btn-small btn-copy" id="btn-save-character">ğŸ’¾ í˜„ì¬ ì„¤ì • ì €ì¥</button>
          </div>
          <div class="saved-characters" id="saved-characters"></div>
        </div>

        <div class="direct-create-form">
          <div class="form-row">
            <div class="form-group">
              <label>ğŸ¯ ì£¼ì¸ê³µ íƒ€ì…</label>
              <select id="direct-subject-type">
                <option value="ì¸ë¬¼">ì¸ë¬¼</option>
                <option value="ë™ë¬¼">ë™ë¬¼</option>
                <option value="ìºë¦­í„°">ìºë¦­í„°/ë§ˆìŠ¤ì½”íŠ¸</option>
                <option value="ì‚¬ë¬¼">ì‚¬ë¬¼</option>
              </select>
            </div>
            <div class="form-group">
              <label>ğŸ‘¤ ì£¼ì¸ê³µ ì„¤ëª…</label>
              <input type="text" id="direct-subject-desc" placeholder="ì˜ˆ: ê·€ì—¬ìš´ ê³ ì–‘ì´, ê°ˆìƒ‰ í„¸, íŒŒë€ ëˆˆ">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ğŸƒ í–‰ë™/ë™ì‘</label>
              <input type="text" id="direct-action" placeholder="ì˜ˆ: ë¬¼ì†ì—ì„œ í—¤ì—„ì¹˜ëŠ”, ì í”„í•˜ëŠ”">
            </div>
            <div class="form-group">
              <label>ğŸ˜Š ê°ì •/í‘œì •</label>
              <input type="text" id="direct-emotion" placeholder="ì˜ˆ: í–‰ë³µí•œ, ë†€ë€, í˜¸ê¸°ì‹¬ ê°€ë“í•œ">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ğŸï¸ ë°°ê²½/ì¥ì†Œ</label>
              <input type="text" id="direct-background" placeholder="ì˜ˆ: ì—´ëŒ€ ë°”ë‹¤, í‘¸ë¥¸ í•˜ëŠ˜">
            </div>
            <div class="form-group">
              <label>ğŸ¨ ìŠ¤íƒ€ì¼</label>
              <select id="direct-style">
                <option value="realistic">ì‚¬ì‹¤ì </option>
                <option value="anime">ì• ë‹ˆë©”ì´ì…˜</option>
                <option value="cartoon">ì¹´íˆ°</option>
                <option value="3d">3D ë Œë”ë§</option>
                <option value="watercolor">ìˆ˜ì±„í™”</option>
                <option value="cinematic">ì˜í™”ì </option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>ğŸ“ ì¶”ê°€ í”„ë¡¬í”„íŠ¸ (ì„ íƒ)</label>
            <textarea id="direct-extra" placeholder="ì¶”ê°€ë¡œ í¬í•¨í•˜ê³  ì‹¶ì€ ìš”ì†Œë¥¼ ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ğŸ¬ ì”¬ ê°œìˆ˜</label>
              <div class="scene-count-selector">
                <button class="scene-count-btn" id="scene-minus">âˆ’</button>
                <span class="scene-count-value" id="scene-count">4</span>
                <button class="scene-count-btn" id="scene-plus">+</button>
              </div>
            </div>
          </div>
        </div>
        <button id="btn-direct-generate" class="btn-primary">
          <span class="spinner" id="direct-spinner"></span>
          <span id="btn-direct-text">ğŸ¬ ì‡¼ì¸  ì˜ìƒ ìƒì„±</span>
        </button>
      </div>
    </div>

    <div id="error-panel" class="error-panel"><span>âš ï¸</span><span id="error-text"></span></div>

    <!-- Progress Panel -->
    <section id="progress-panel" class="progress-panel">
      <div class="progress-steps">
        <div class="progress-step" data-step="1"><div class="step-icon">ğŸ“¤</div><span class="step-label">ì—…ë¡œë“œ</span></div>
        <div class="progress-step" data-step="2"><div class="step-icon">ğŸ”</div><span class="step-label">ì”¬ ê°ì§€</span></div>
        <div class="progress-step" data-step="3"><div class="step-icon">ğŸ¤–</div><span class="step-label">GPT-5.1 ë¶„ì„</span></div>
        <div class="progress-step" data-step="4"><div class="step-icon">âœ¨</div><span class="step-label">ì™„ë£Œ</span></div>
      </div>
      <div class="progress-bar-wrap"><div id="progress-bar" class="progress-bar"></div></div>
      <div id="progress-text" class="progress-text">ì˜ìƒ ì—…ë¡œë“œ ì¤‘...</div>
    </section>

    <!-- Results Panel -->
    <section id="results-panel" class="results-panel">
      <div class="results-header">
        <div class="results-title">
          <span style="font-size:1.4rem;">âœ…</span>
          <div>
            <h3>ë¶„ì„ ì™„ë£Œ</h3>
            <div class="results-meta">
              <span id="video-duration">ì˜ìƒ ê¸¸ì´: -</span>
              <span id="frame-count">ì”¬: -</span>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn-secondary" id="btn-copy-all"><span>ğŸ“‹</span> ì „ì²´ ë³µì‚¬</button>
          <button class="btn-primary" style="width:auto;margin:0;" id="btn-generate-shorts"><span>ğŸ¬</span> ì‡¼ì¸  ìƒì„±</button>
        </div>
      </div>

      <!-- Character Override Section -->
      <div class="character-section" id="character-override-section">
        <div class="character-header">
          <h4>ğŸ­ ì£¼ì¸ê³µ ì¼ê´„ ë³€ê²½</h4>
          <button class="btn-small btn-regenerate" id="btn-apply-character">ì ìš©</button>
        </div>
        <div class="saved-characters" id="results-saved-characters"></div>
        <div class="character-form">
          <div class="form-group">
            <label>ì£¼ì¸ê³µ</label>
            <input type="text" id="override-subject" placeholder="ì˜ˆ: ê·€ì—¬ìš´ ê°•ì•„ì§€">
          </div>
          <div class="form-group">
            <label>í–‰ë™</label>
            <input type="text" id="override-action" placeholder="ì˜ˆ: ë‹¬ë¦¬ëŠ”">
          </div>
        </div>
      </div>

      <div class="scene-list" id="scene-list"></div>

      <!-- Generated Images Section -->
      <div class="generated-section" id="generated-images-section">
        <h4>ğŸ–¼ï¸ ìƒì„±ëœ ì´ë¯¸ì§€ <span id="image-gen-status" style="font-weight:400;color:#64748b;font-size:0.85rem;"></span></h4>
        <div class="images-grid" id="generated-images-grid"></div>
      </div>

      <!-- Final Video Section -->
      <div class="generated-section" id="final-video-section">
        <h4>ğŸ¥ ìƒì„±ëœ ì‡¼ì¸  ì˜ìƒ</h4>
        <div class="video-result">
          <video id="final-shorts-video" controls></video>
          <div><a id="download-shorts-link" href="#" download class="download-btn"><span>â¬‡ï¸</span> ì˜ìƒ ë‹¤ìš´ë¡œë“œ</a></div>
        </div>
      </div>
    </section>

    <!-- Shorts Generation Progress -->
    <section id="shorts-progress-panel" class="progress-panel">
      <div class="progress-steps">
        <div class="progress-step shorts-step" data-step="1"><div class="step-icon">ğŸ¨</div><span class="step-label">ì´ë¯¸ì§€ ìƒì„±</span></div>
        <div class="progress-step shorts-step" data-step="2"><div class="step-icon">ğŸ”Š</div><span class="step-label">ì˜¤ë””ì˜¤</span></div>
        <div class="progress-step shorts-step" data-step="3"><div class="step-icon">ğŸ¬</div><span class="step-label">ì˜ìƒ í•©ì„±</span></div>
        <div class="progress-step shorts-step" data-step="4"><div class="step-icon">âœ¨</div><span class="step-label">ì™„ë£Œ</span></div>
      </div>
      <div class="progress-bar-wrap"><div id="shorts-progress-bar" class="progress-bar"></div></div>
      <div id="shorts-progress-text" class="progress-text">ì´ë¯¸ì§€ ìƒì„± ì¤€ë¹„ ì¤‘...</div>
    </section>
  </main>

  <script>
    // ========== Tab Switching ==========
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
        hideError();
      });
    });

    // ========== Character Storage ==========
    function loadSavedCharacters() {
      const chars = JSON.parse(localStorage.getItem('shortsCharacters') || '[]');
      renderCharacterChips('saved-characters', chars, true);
      renderCharacterChips('results-saved-characters', chars, false);
    }

    function saveCharacter(name, data) {
      const chars = JSON.parse(localStorage.getItem('shortsCharacters') || '[]');
      const existing = chars.findIndex(c => c.name === name);
      if (existing >= 0) chars[existing] = { name, ...data };
      else chars.push({ name, ...data });
      localStorage.setItem('shortsCharacters', JSON.stringify(chars));
      loadSavedCharacters();
    }

    function deleteCharacter(name) {
      let chars = JSON.parse(localStorage.getItem('shortsCharacters') || '[]');
      chars = chars.filter(c => c.name !== name);
      localStorage.setItem('shortsCharacters', JSON.stringify(chars));
      loadSavedCharacters();
    }

    function renderCharacterChips(containerId, chars, showDelete) {
      const container = document.getElementById(containerId);
      container.innerHTML = chars.length === 0
        ? '<span style="color:#64748b;font-size:0.85rem;">ì €ì¥ëœ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤</span>'
        : chars.map(c => `
          <div class="character-chip" data-char='${JSON.stringify(c)}'>
            <span>${c.name}</span>
            ${showDelete ? '<span class="delete-char" onclick="event.stopPropagation();deleteCharacter(\'' + c.name + '\')">Ã—</span>' : ''}
          </div>
        `).join('');

      container.querySelectorAll('.character-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          const data = JSON.parse(chip.dataset.char);
          applyCharacterToForm(data);
        });
      });
    }

    function applyCharacterToForm(data) {
      if (data.subjectType) document.getElementById('direct-subject-type').value = data.subjectType;
      if (data.subject) document.getElementById('direct-subject-desc').value = data.subject;
      if (data.action) document.getElementById('direct-action').value = data.action;
      if (data.emotion) document.getElementById('direct-emotion').value = data.emotion;
      if (data.background) document.getElementById('direct-background').value = data.background;
      if (data.style) document.getElementById('direct-style').value = data.style;

      document.getElementById('override-subject').value = data.subject || '';
      document.getElementById('override-action').value = data.action || '';
    }

    document.getElementById('btn-save-character').addEventListener('click', () => {
      const name = prompt('ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
      if (!name) return;
      saveCharacter(name, {
        subjectType: document.getElementById('direct-subject-type').value,
        subject: document.getElementById('direct-subject-desc').value,
        action: document.getElementById('direct-action').value,
        emotion: document.getElementById('direct-emotion').value,
        background: document.getElementById('direct-background').value,
        style: document.getElementById('direct-style').value
      });
      alert('ìºë¦­í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    });

    loadSavedCharacters();

    // ========== Scene Count ==========
    let sceneCount = 4;
    document.getElementById('scene-minus').addEventListener('click', () => {
      if (sceneCount > 2) document.getElementById('scene-count').textContent = --sceneCount;
    });
    document.getElementById('scene-plus').addEventListener('click', () => {
      if (sceneCount < 10) document.getElementById('scene-count').textContent = ++sceneCount;
    });

    // ========== Video Upload ==========
    const videoDropZone = document.getElementById('video-drop-zone');
    const videoUpload = document.getElementById('video-upload');
    const videoUploadContent = document.getElementById('video-upload-content');
    const videoPreviewContainer = document.getElementById('video-preview-container');
    const previewVideo = document.getElementById('preview-video');
    const videoFileName = document.getElementById('video-file-name');
    const modeSelect = document.getElementById('mode');
    const btnAnalyze = document.getElementById('btn-analyze');
    let selectedVideoFile = null;
    let analysisResults = null;

    videoDropZone.addEventListener('click', e => {
      if (!e.target.closest('.preview-container') && e.target.id !== 'btn-change-video') videoUpload.click();
    });
    videoDropZone.addEventListener('dragover', e => { e.preventDefault(); videoDropZone.classList.add('dragover'); });
    videoDropZone.addEventListener('dragleave', () => videoDropZone.classList.remove('dragover'));
    videoDropZone.addEventListener('drop', e => {
      e.preventDefault(); videoDropZone.classList.remove('dragover');
      if (e.dataTransfer.files[0]?.type.startsWith('video/')) handleVideoSelect(e.dataTransfer.files[0]);
      else showError('ë¹„ë””ì˜¤ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
    });
    videoUpload.addEventListener('change', e => { if (e.target.files[0]) handleVideoSelect(e.target.files[0]); });
    document.getElementById('btn-change-video').addEventListener('click', e => { e.stopPropagation(); videoUpload.click(); });

    function handleVideoSelect(file) {
      if (file.size > 100 * 1024 * 1024) { showError('íŒŒì¼ í¬ê¸°ëŠ” 100MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤'); return; }
      selectedVideoFile = file;
      previewVideo.src = URL.createObjectURL(file);
      videoFileName.textContent = file.name + ' (' + (file.size / 1024 / 1024).toFixed(1) + 'MB)';
      videoUploadContent.style.display = 'none';
      videoPreviewContainer.classList.add('active');
      btnAnalyze.disabled = false;
      hideError();
    }

    modeSelect.addEventListener('change', () => {
      document.getElementById('interval-group').style.display = modeSelect.value === 'interval' ? 'block' : 'none';
      document.getElementById('threshold-group').style.display = modeSelect.value === 'scene' ? 'block' : 'none';
    });

    // ========== Video Analysis ==========
    btnAnalyze.addEventListener('click', async () => {
      if (!selectedVideoFile) { showError('ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
      hideError();
      document.getElementById('results-panel').classList.remove('active');
      document.getElementById('progress-panel').classList.add('active');
      btnAnalyze.disabled = true;
      document.getElementById('video-spinner').style.display = 'block';
      document.getElementById('btn-analyze-text').textContent = 'ë¶„ì„ ì¤‘...';
      document.querySelectorAll('.progress-step').forEach(s => s.classList.remove('active', 'completed'));

      const steps = [
        { step: 1, percent: 15, text: 'ì˜ìƒ ì—…ë¡œë“œ ì¤‘...' },
        { step: 2, percent: 35, text: modeSelect.value === 'scene' ? 'ì”¬ ë³€í™” ê°ì§€ ì¤‘...' : 'í”„ë ˆì„ ì¶”ì¶œ ì¤‘...' },
        { step: 3, percent: 60, text: 'GPT-5.1 ë¶„ì„ ì¤‘...' },
        { step: 4, percent: 90, text: 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...' }
      ];
      let stepIdx = 0;
      const progressInterval = setInterval(() => {
        if (stepIdx < steps.length) {
          updateProgress(steps[stepIdx].step, steps[stepIdx].percent, steps[stepIdx].text);
          stepIdx++;
        }
      }, 3000);

      try {
        const formData = new FormData();
        formData.append('video', selectedVideoFile);
        formData.append('mode', modeSelect.value);
        formData.append('interval', document.getElementById('interval').value);
        formData.append('threshold', document.getElementById('threshold').value);

        const response = await fetch('/api/tubelens/video-to-prompts', { method: 'POST', body: formData });
        clearInterval(progressInterval);
        const data = await response.json();

        if (data.success) {
          analysisResults = data;
          updateProgress(4, 100, 'ì™„ë£Œ!');
          document.querySelectorAll('.progress-step').forEach(s => { s.classList.remove('active'); s.classList.add('completed'); });
          setTimeout(() => {
            document.getElementById('progress-panel').classList.remove('active');
            displayResults(data);
          }, 800);
        } else {
          document.getElementById('progress-panel').classList.remove('active');
          showError(data.message || 'ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      } catch (error) {
        clearInterval(progressInterval);
        document.getElementById('progress-panel').classList.remove('active');
        showError('ì„œë²„ ì˜¤ë¥˜: ' + error.message);
      } finally {
        btnAnalyze.disabled = false;
        document.getElementById('video-spinner').style.display = 'none';
        document.getElementById('btn-analyze-text').textContent = 'GPT-5.1ë¡œ ë¶„ì„ ì‹œì‘';
      }
    });

    function updateProgress(step, percent, text) {
      document.getElementById('progress-bar').style.width = percent + '%';
      document.getElementById('progress-text').textContent = text;
      document.querySelectorAll('.progress-step').forEach((el, idx) => {
        if (idx < step - 1) { el.classList.remove('active'); el.classList.add('completed'); }
        else if (idx === step - 1) el.classList.add('active');
      });
    }

    function displayResults(data) {
      document.getElementById('video-duration').textContent = `ì˜ìƒ ê¸¸ì´: ${data.duration}ì´ˆ`;
      document.getElementById('frame-count').textContent = `ì”¬: ${data.frameCount}ê°œ`;

      const sceneList = document.getElementById('scene-list');
      sceneList.innerHTML = '';

      data.prompts.forEach((scene, idx) => {
        const analysis = scene.analysis || {};
        const subject = analysis.subject || {};
        const action = analysis.action || {};
        const background = analysis.background || {};
        const style = analysis.style || {};

        const card = document.createElement('div');
        card.className = 'scene-card';
        card.dataset.index = idx;
        card.innerHTML = `
          <div class="scene-header">
            <span class="scene-badge">Scene ${idx + 1}</span>
            <span class="scene-time">${scene.time}ì´ˆ</span>
          </div>
          <div class="scene-analysis">
            <div class="analysis-field">
              <label>ğŸ¯ ì£¼ì¸ê³µ</label>
              <input type="text" class="edit-subject" value="${escapeHtml(subject.description || '')}">
            </div>
            <div class="analysis-field">
              <label>ğŸƒ í–‰ë™</label>
              <input type="text" class="edit-action" value="${escapeHtml(action.main || '')}">
            </div>
            <div class="analysis-field">
              <label>ğŸ˜Š ê°ì •</label>
              <input type="text" class="edit-emotion" value="${escapeHtml(action.emotion || '')}">
            </div>
            <div class="analysis-field">
              <label>ğŸï¸ ë°°ê²½</label>
              <input type="text" class="edit-background" value="${escapeHtml(background.location || '')}">
            </div>
            <div class="analysis-field">
              <label>ğŸ’¡ ì¡°ëª…</label>
              <input type="text" class="edit-lighting" value="${escapeHtml(style.lighting || '')}">
            </div>
            <div class="analysis-field">
              <label>ğŸ¨ ìŠ¤íƒ€ì¼</label>
              <input type="text" class="edit-style" value="${escapeHtml(style.mood || '')}">
            </div>
          </div>
          <div class="prompt-box">
            <label>ğŸ“ ìµœì¢… í”„ë¡¬í”„íŠ¸ (ì˜ì–´)</label>
            <textarea class="edit-prompt">${escapeHtml(scene.prompt || '')}</textarea>
          </div>
          <div class="scene-actions">
            <button class="btn-small btn-regenerate btn-rebuild-prompt" data-index="${idx}">ğŸ”„ í”„ë¡¬í”„íŠ¸ ì¬ìƒì„±</button>
            <button class="btn-small btn-copy btn-copy-scene" data-index="${idx}">ğŸ“‹ ë³µì‚¬</button>
          </div>
        `;
        sceneList.appendChild(card);
      });

      // Event listeners for scene actions
      document.querySelectorAll('.btn-copy-scene').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.index);
          const prompt = document.querySelectorAll('.scene-card')[idx].querySelector('.edit-prompt').value;
          copyToClipboard(prompt, btn);
        });
      });

      document.querySelectorAll('.btn-rebuild-prompt').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.index);
          rebuildPrompt(idx);
        });
      });

      document.getElementById('results-panel').classList.add('active');
      document.getElementById('generated-images-section').classList.remove('active');
      document.getElementById('final-video-section').classList.remove('active');
    }

    function rebuildPrompt(idx) {
      const card = document.querySelectorAll('.scene-card')[idx];
      const subject = card.querySelector('.edit-subject').value;
      const action = card.querySelector('.edit-action').value;
      const emotion = card.querySelector('.edit-emotion').value;
      const background = card.querySelector('.edit-background').value;
      const lighting = card.querySelector('.edit-lighting').value;
      const style = card.querySelector('.edit-style').value;

      const newPrompt = [subject, action, emotion, background, lighting, style].filter(Boolean).join(', ') + ', high quality, vertical format, 9:16 aspect ratio';
      card.querySelector('.edit-prompt').value = newPrompt;
    }

    // ========== Apply Character Override ==========
    document.getElementById('btn-apply-character').addEventListener('click', () => {
      const subject = document.getElementById('override-subject').value.trim();
      const action = document.getElementById('override-action').value.trim();
      if (!subject && !action) { showError('ì£¼ì¸ê³µ ë˜ëŠ” í–‰ë™ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

      document.querySelectorAll('.scene-card').forEach((card, idx) => {
        if (subject) card.querySelector('.edit-subject').value = subject;
        if (action) card.querySelector('.edit-action').value = action;
        rebuildPrompt(idx);
      });
      hideError();
    });

    // ========== Copy All ==========
    document.getElementById('btn-copy-all').addEventListener('click', () => {
      const prompts = [];
      document.querySelectorAll('.scene-card').forEach((card, idx) => {
        prompts.push(`[Scene ${idx + 1}]\n${card.querySelector('.edit-prompt').value}`);
      });
      copyToClipboard(prompts.join('\n\n---\n\n'), document.getElementById('btn-copy-all'));
    });

    // ========== Shorts Generation ==========
    let generatedImages = [];
    document.getElementById('btn-generate-shorts').addEventListener('click', generateShorts);

    async function generateShorts() {
      const sceneCards = document.querySelectorAll('.scene-card');
      if (sceneCards.length === 0) { showError('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }

      hideError();
      generatedImages = [];
      document.getElementById('generated-images-grid').innerHTML = '';
      document.getElementById('generated-images-section').classList.remove('active');
      document.getElementById('final-video-section').classList.remove('active');
      document.getElementById('shorts-progress-panel').classList.add('active');
      document.getElementById('btn-generate-shorts').disabled = true;
      document.querySelectorAll('.shorts-step').forEach(s => s.classList.remove('active', 'completed'));

      try {
        updateShortsProgress(1, 10, 'ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
        document.getElementById('generated-images-section').classList.add('active');
        const totalImages = sceneCards.length;

        for (let i = 0; i < totalImages; i++) {
          const prompt = sceneCards[i].querySelector('.edit-prompt').value;
          document.getElementById('image-gen-status').textContent = `${i + 1} / ${totalImages} ìƒì„± ì¤‘...`;

          try {
            const imgResponse = await fetch('/api/drama/generate-image', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt: prompt, size: '1080x1920', imageProvider: 'gemini' })
            });
            const imgData = await imgResponse.json();

            if ((imgData.success || imgData.ok) && imgData.imageUrl) {
              generatedImages.push(imgData.imageUrl);
              addImageCard(imgData.imageUrl, i + 1);
            } else {
              addFailedImageCard(i + 1, imgData.error || 'ìƒì„± ì‹¤íŒ¨');
            }
          } catch (e) {
            addFailedImageCard(i + 1, e.message);
          }
          document.getElementById('shorts-progress-bar').style.width = (10 + 40 * (i + 1) / totalImages) + '%';
        }

        document.getElementById('image-gen-status').textContent = `${generatedImages.length} / ${totalImages} ì™„ë£Œ`;
        updateShortsStep(1, 'completed');

        if (generatedImages.length === 0) throw new Error('ì´ë¯¸ì§€ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        // Step 2: Audio
        updateShortsProgress(2, 55, 'ì˜¤ë””ì˜¤ ì¤€ë¹„ ì¤‘...');
        let audioUrl = null;
        try {
          const ttsResp = await fetch('/api/tts/generate', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: 'ì´ ì˜ìƒì€ AIê°€ ìƒì„±í•œ ì‡¼ì¸ ì…ë‹ˆë‹¤.', language: 'ko' })
          });
          const ttsData = await ttsResp.json();
          if (ttsData.success) audioUrl = ttsData.audioUrl;
        } catch (e) { console.warn('TTS failed'); }
        updateShortsStep(2, 'completed');

        // Step 3: Video
        updateShortsProgress(3, 70, 'ì˜ìƒ í•©ì„± ì¤‘...');
        const videoResp = await fetch('/api/shorts/generate-video', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ images: generatedImages, audioUrl: audioUrl || '', effect: 'kenburns', imageDuration: 3 })
        });
        const videoData = await videoResp.json();
        updateShortsStep(3, 'completed');

        if (videoData.ok && videoData.videoUrl) {
          updateShortsProgress(4, 100, 'ì™„ë£Œ!');
          updateShortsStep(4, 'completed');
          setTimeout(() => {
            document.getElementById('shorts-progress-panel').classList.remove('active');
            document.getElementById('final-video-section').classList.add('active');
            document.getElementById('final-shorts-video').src = videoData.videoUrl;
            document.getElementById('download-shorts-link').href = videoData.videoUrl;
            document.getElementById('final-video-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 800);
        } else throw new Error(videoData.error || 'ì˜ìƒ ìƒì„± ì‹¤íŒ¨');

      } catch (error) {
        document.getElementById('shorts-progress-panel').classList.remove('active');
        showError('ì‡¼ì¸  ìƒì„± ì‹¤íŒ¨: ' + error.message);
      } finally {
        document.getElementById('btn-generate-shorts').disabled = false;
      }
    }

    function addImageCard(url, num) {
      const grid = document.getElementById('generated-images-grid');
      const card = document.createElement('div');
      card.className = 'image-card';
      card.innerHTML = `<img src="${url}" alt="Scene ${num}"><div class="overlay">Scene ${num}</div>`;
      grid.appendChild(card);
    }

    function addFailedImageCard(num, error) {
      const grid = document.getElementById('generated-images-grid');
      const card = document.createElement('div');
      card.className = 'image-card failed';
      card.innerHTML = `<strong>Scene ${num}</strong><br><small>${error}</small>`;
      grid.appendChild(card);
    }

    function updateShortsProgress(step, percent, text) {
      document.getElementById('shorts-progress-bar').style.width = percent + '%';
      document.getElementById('shorts-progress-text').textContent = text;
      document.querySelectorAll('.shorts-step').forEach((el, idx) => {
        if (idx < step - 1) { el.classList.remove('active'); el.classList.add('completed'); }
        else if (idx === step - 1) el.classList.add('active');
      });
    }

    function updateShortsStep(step, state) {
      const el = document.querySelector(`.shorts-step[data-step="${step}"]`);
      el.classList.remove('active');
      el.classList.add(state);
    }

    // ========== Direct Create ==========
    document.getElementById('btn-direct-generate').addEventListener('click', async () => {
      const subjectType = document.getElementById('direct-subject-type').value;
      const subject = document.getElementById('direct-subject-desc').value.trim();
      const action = document.getElementById('direct-action').value.trim();
      const emotion = document.getElementById('direct-emotion').value.trim();
      const background = document.getElementById('direct-background').value.trim();
      const styleVal = document.getElementById('direct-style').value;
      const extra = document.getElementById('direct-extra').value.trim();
      const count = parseInt(document.getElementById('scene-count').textContent);

      if (!subject) { showError('ì£¼ì¸ê³µ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

      hideError();
      document.getElementById('shorts-progress-panel').classList.add('active');
      document.getElementById('btn-direct-generate').disabled = true;
      document.getElementById('direct-spinner').style.display = 'block';
      document.getElementById('btn-direct-text').textContent = 'ìƒì„± ì¤‘...';
      document.querySelectorAll('.shorts-step').forEach(s => s.classList.remove('active', 'completed'));

      generatedImages = [];
      document.getElementById('generated-images-grid').innerHTML = '';
      document.getElementById('generated-images-section').classList.add('active');
      document.getElementById('final-video-section').classList.remove('active');
      document.getElementById('results-panel').classList.add('active');
      document.getElementById('scene-list').innerHTML = '';
      document.getElementById('character-override-section').style.display = 'none';

      const styleMap = { realistic: 'photorealistic', anime: 'anime style', cartoon: 'cartoon style', '3d': '3D rendered', watercolor: 'watercolor painting', cinematic: 'cinematic' };
      const styleText = styleMap[styleVal] || '';

      try {
        updateShortsProgress(1, 10, 'ì´ë¯¸ì§€ ìƒì„± ì¤‘...');

        for (let i = 0; i < count; i++) {
          const prompt = [subject, action, emotion, background, styleText, extra, 'high quality, vertical format, 9:16 aspect ratio'].filter(Boolean).join(', ');
          document.getElementById('image-gen-status').textContent = `${i + 1} / ${count} ìƒì„± ì¤‘...`;

          try {
            const imgResp = await fetch('/api/drama/generate-image', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt, size: '1080x1920', imageProvider: 'gemini' })
            });
            const imgData = await imgResp.json();
            if ((imgData.success || imgData.ok) && imgData.imageUrl) {
              generatedImages.push(imgData.imageUrl);
              addImageCard(imgData.imageUrl, i + 1);
            } else {
              addFailedImageCard(i + 1, imgData.error || 'ìƒì„± ì‹¤íŒ¨');
            }
          } catch (e) {
            addFailedImageCard(i + 1, e.message);
          }
          document.getElementById('shorts-progress-bar').style.width = (10 + 40 * (i + 1) / count) + '%';
        }

        document.getElementById('image-gen-status').textContent = `${generatedImages.length} / ${count} ì™„ë£Œ`;
        updateShortsStep(1, 'completed');

        if (generatedImages.length === 0) throw new Error('ì´ë¯¸ì§€ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        // Audio
        updateShortsProgress(2, 55, 'ì˜¤ë””ì˜¤ ì¤€ë¹„ ì¤‘...');
        let audioUrl = null;
        try {
          const ttsResp = await fetch('/api/tts/generate', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: 'ì´ ì˜ìƒì€ AIê°€ ìƒì„±í•œ ì‡¼ì¸ ì…ë‹ˆë‹¤.', language: 'ko' })
          });
          const ttsData = await ttsResp.json();
          if (ttsData.success) audioUrl = ttsData.audioUrl;
        } catch (e) {}
        updateShortsStep(2, 'completed');

        // Video
        updateShortsProgress(3, 70, 'ì˜ìƒ í•©ì„± ì¤‘...');
        const videoResp = await fetch('/api/shorts/generate-video', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ images: generatedImages, audioUrl: audioUrl || '', effect: 'kenburns', imageDuration: 3 })
        });
        const videoData = await videoResp.json();
        updateShortsStep(3, 'completed');

        if (videoData.ok && videoData.videoUrl) {
          updateShortsProgress(4, 100, 'ì™„ë£Œ!');
          updateShortsStep(4, 'completed');
          setTimeout(() => {
            document.getElementById('shorts-progress-panel').classList.remove('active');
            document.getElementById('final-video-section').classList.add('active');
            document.getElementById('final-shorts-video').src = videoData.videoUrl;
            document.getElementById('download-shorts-link').href = videoData.videoUrl;
            document.getElementById('final-video-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 800);
        } else throw new Error(videoData.error || 'ì˜ìƒ ìƒì„± ì‹¤íŒ¨');

      } catch (error) {
        document.getElementById('shorts-progress-panel').classList.remove('active');
        showError('ìƒì„± ì‹¤íŒ¨: ' + error.message);
      } finally {
        document.getElementById('btn-direct-generate').disabled = false;
        document.getElementById('direct-spinner').style.display = 'none';
        document.getElementById('btn-direct-text').textContent = 'ğŸ¬ ì‡¼ì¸  ì˜ìƒ ìƒì„±';
      }
    });

    // ========== Image Analysis Tab ==========
    const imageDropZone = document.getElementById('image-drop-zone');
    const imageUpload = document.getElementById('image-upload');
    const imageUploadContent = document.getElementById('image-upload-content');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const previewImage = document.getElementById('preview-image');
    const imageFileName = document.getElementById('image-file-name');
    const btnAnalyzeImage = document.getElementById('btn-analyze-image');
    let selectedImageFile = null;

    imageDropZone.addEventListener('click', e => {
      if (!e.target.closest('.preview-container') && e.target.id !== 'btn-change-image') imageUpload.click();
    });
    imageDropZone.addEventListener('dragover', e => { e.preventDefault(); imageDropZone.classList.add('dragover'); });
    imageDropZone.addEventListener('dragleave', () => imageDropZone.classList.remove('dragover'));
    imageDropZone.addEventListener('drop', e => {
      e.preventDefault(); imageDropZone.classList.remove('dragover');
      if (e.dataTransfer.files[0]?.type.startsWith('image/')) handleImageSelect(e.dataTransfer.files[0]);
    });
    imageUpload.addEventListener('change', e => { if (e.target.files[0]) handleImageSelect(e.target.files[0]); });
    document.getElementById('btn-change-image').addEventListener('click', e => { e.stopPropagation(); imageUpload.click(); });

    function handleImageSelect(file) {
      selectedImageFile = file;
      const reader = new FileReader();
      reader.onload = e => {
        previewImage.src = e.target.result;
        imageFileName.textContent = file.name;
        imageUploadContent.style.display = 'none';
        imagePreviewContainer.classList.add('active');
        btnAnalyzeImage.disabled = false;
        hideError();
      };
      reader.readAsDataURL(file);
    }

    btnAnalyzeImage.addEventListener('click', async () => {
      if (!selectedImageFile) { showError('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
      hideError();
      btnAnalyzeImage.disabled = true;
      document.getElementById('image-spinner').style.display = 'block';
      document.getElementById('btn-analyze-image-text').textContent = 'ë¶„ì„ ì¤‘...';

      try {
        const formData = new FormData();
        formData.append('image', selectedImageFile);
        const resp = await fetch('/api/tubelens/image-to-prompt', { method: 'POST', body: formData });
        const data = await resp.json();
        if (data.success) {
          // Show result in direct create tab
          if (data.analysis) {
            document.getElementById('direct-subject-desc').value = data.analysis.subject || '';
            document.getElementById('direct-action').value = '';
            document.getElementById('direct-background').value = data.analysis.background || '';
          }
          document.getElementById('direct-extra').value = data.prompt || '';
          document.querySelector('.tab[data-tab="direct"]').click();
          alert('ë¶„ì„ ì™„ë£Œ! ì§ì ‘ ìƒì„± íƒ­ì—ì„œ í”„ë¡¬í”„íŠ¸ë¥¼ í™•ì¸í•˜ê³  í¸ì§‘í•˜ì„¸ìš”.');
        } else showError(data.message || 'ë¶„ì„ ì‹¤íŒ¨');
      } catch (error) {
        showError('ì„œë²„ ì˜¤ë¥˜: ' + error.message);
      } finally {
        btnAnalyzeImage.disabled = false;
        document.getElementById('image-spinner').style.display = 'none';
        document.getElementById('btn-analyze-image-text').textContent = 'ì´ë¯¸ì§€ ë¶„ì„';
      }
    });

    // ========== Utilities ==========
    function showError(msg) {
      document.getElementById('error-text').textContent = msg;
      document.getElementById('error-panel').classList.add('active');
    }
    function hideError() { document.getElementById('error-panel').classList.remove('active'); }
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
    function copyToClipboard(text, btn) {
      navigator.clipboard.writeText(text).then(() => {
        const orig = btn.innerHTML;
        btn.innerHTML = 'âœ“ ë³µì‚¬ë¨';
        btn.classList.add('copied');
        setTimeout(() => { btn.innerHTML = orig; btn.classList.remove('copied'); }, 2000);
      });
    }
  </script>
</body>
</html>
