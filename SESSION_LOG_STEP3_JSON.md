# Session Log: Step3 스타일별 지침 JSON 구조

## 최종 업데이트
2025-11-27

---

## 완료된 작업 요약

### Phase 1 (2025-11-26): 시스템 구조 구축
- Step3도 스타일별 JSON 지침 사용하도록 변경
- 프론트엔드/백엔드 수정 완료

### Phase 2 (2025-11-27): 3대지 JSON 지침 최종 완성
- Step1, Step2, Step3 JSON 지침 작성
- GPT 검증 및 절충안 도출
- 시스템 호환성 분석

---

## 3대지 설교 스타일 - 최종 완성형 JSON 지침

### Step 1: 본문 분석

```json
{
  "style": "3대지",
  "step": "step1",
  "role": "본문 분석가",
  "principle": "본문의 의미를 객관적으로 해석하되, 적용이나 설교 구조는 다루지 않는다",
  "task": "성경 본문의 역사적·문법적·신학적 의미를 분석하여 Step2의 구조 설계를 위한 재료를 제공한다",
  "output_format": {
    "type": "JSON",
    "structure": {
      "본문_개요": "본문의 역사적 배경, 저자 의도, 문맥 요약",
      "핵심_단어_분석": {
        "단어(원어)": "의미와 신학적 함의"
      },
      "구조_분석": {
        "단락구분": "절 범위와 내용 요약"
      },
      "주요_절_해설": {
        "절번호": {
          "본문": "해당 절 내용",
          "해석": "문법적·신학적 의미"
        }
      },
      "대지_후보": ["본문에서 도출 가능한 3~5개 핵심 포인트 (절 번호 포함)"],
      "핵심_메시지": "본문 전체가 전달하는 중심 진리 (1-2문장)",
      "신학적_주제": ["본문에서 도출되는 주요 신학적 주제들"]
    }
  },
  "output_example": {
    "본문_개요": "바울이 빌립보 교회에 보낸 서신으로, 옥중에서도 기쁨을 강조한다",
    "핵심_단어_분석": {
      "기쁨(χαρά)": "외적 상황과 무관한 내적 기쁨, 주 안에서의 기쁨",
      "염려(μεριμνάω)": "분열된 마음, 불안한 상태"
    },
    "구조_분석": {
      "4-5절": "기쁨의 명령과 관용",
      "6-7절": "염려 대신 기도",
      "8-9절": "생각의 초점"
    },
    "주요_절_해설": {
      "4절": {
        "본문": "주 안에서 항상 기뻐하라 내가 다시 말하노니 기뻐하라",
        "해석": "기쁨은 감정이 아닌 의지적 선택이며, 반복 강조는 그 중요성을 나타냄"
      },
      "6절": {
        "본문": "아무 것도 염려하지 말고...",
        "해석": "염려의 해결책으로 기도를 제시, 감사와 함께하는 기도 강조"
      }
    },
    "대지_후보": [
      "기쁨의 명령 - 의지적 선택 (4절)",
      "염려를 기도로 바꾸라 (6절)",
      "하나님의 평강이 마음을 지킴 (7절)",
      "생각의 초점을 선한 것에 (8절)"
    ],
    "핵심_메시지": "주 안에서 기뻐하고, 염려를 기도로 바꾸면 하나님의 평강이 마음을 지킨다",
    "신학적_주제": ["그리스도 안에서의 기쁨", "기도와 평강", "그리스도인의 사고방식"]
  },
  "interpretation_rules": {
    "허용": ["원어 분석", "역사적 배경 설명", "문맥 해석", "신학적 의미 도출"],
    "금지": ["현대적 적용", "설교 구조 제안", "예화 삽입", "청중 언급"]
  },
  "quality_criteria": [
    "본문에 충실한 해석인가",
    "주요 절에 대한 해설이 명확한가",
    "대지 후보가 3~5개 제공되었는가",
    "핵심 메시지가 본문에서 도출되었는가"
  ]
}
```

### Step 2: 구조 설계

```json
{
  "style": "3대지",
  "step": "step2",
  "role": "설교 구조 설계자",
  "principle": "Step1의 해석과 대지 후보를 바탕으로 3개의 대지로 구조화하되, 새로운 해석을 추가하지 않는다",
  "task": "Step1 분석 결과에서 대지 후보를 선택하여 3대지 구조로 조직하고, Step3를 위한 설계도를 완성한다",
  "input_reference": {
    "필수_참조": "Step1의 핵심_메시지, 대지_후보, 주요_절_해설, 신학적_주제",
    "주의": "대지는 반드시 Step1의 대지_후보에서 선택할 것"
  },
  "output_format": {
    "type": "JSON",
    "structure": {
      "설교_제목": "본문의 핵심 메시지를 반영한 제목",
      "서론_방향": "청중의 관심을 끌고 본문으로 이끄는 도입 방향",
      "대지_1": {
        "소제목": "첫 번째 핵심 포인트",
        "본문_근거": "절 번호",
        "핵심_내용": "Step1 해설 기반 정리",
        "전개_방향": "설명-예증-적용의 방향성"
      },
      "대지_2": {
        "소제목": "두 번째 핵심 포인트",
        "본문_근거": "절 번호",
        "핵심_내용": "Step1 해설 기반 정리",
        "전개_방향": "설명-예증-적용의 방향성"
      },
      "대지_3": {
        "소제목": "세 번째 핵심 포인트",
        "본문_근거": "절 번호",
        "핵심_내용": "Step1 해설 기반 정리",
        "전개_방향": "설명-예증-적용의 방향성"
      },
      "결론_방향": "3대지를 종합하고 삶의 적용으로 마무리하는 방향",
      "대지_연결_흐름": "3개 대지가 어떻게 유기적으로 연결되는지 설명"
    }
  },
  "interpretation_rules": {
    "허용": ["Step1 내용 재구성", "대지 간 연결 논리 구성", "적용 방향 제시"],
    "금지": ["Step1에 없는 새로운 해석 추가", "본문에 없는 내용 삽입", "구체적 예화 작성"]
  },
  "quality_criteria": [
    "대지가 Step1의 대지_후보에서 선택되었는가",
    "각 대지에 절 번호 근거가 있는가",
    "3개 대지가 균형있게 구성되었는가",
    "대지 간 논리적 흐름이 자연스러운가"
  ]
}
```

### Step 3: 설교문 작성

```json
{
  "style": "3대지",
  "step": "step3",
  "role": "설교문 작성자",
  "principle": "Step1의 해석과 Step2의 구조를 충실히 따라 설교문을 작성하며, 새로운 해석이나 구조 변경 없이 글로 완성한다",
  "task": "Step1+Step2 자료를 바탕으로 완성된 설교문 작성",
  "input_reference": {
    "Step1에서_가져올_것": "본문_개요, 핵심_단어_분석, 주요_절_해설, 핵심_메시지",
    "Step2에서_가져올_것": "설교_제목, 서론_방향, 대지_1/2/3, 결론_방향, 대지_연결_흐름",
    "시스템_설정_참조": "분량, 대상, 예배유형 정보 반영"
  },
  "output_format": {
    "type": "완성된 설교문 (마크다운)",
    "structure": {
      "제목": "Step2의 설교_제목 사용",
      "서론": "Step2 서론_방향을 구체적 글로 전개 (청중 공감, 본문 도입)",
      "본론": {
        "대지1": "Step2 대지_1을 설명-예증-적용 구조로 전개",
        "대지2": "Step2 대지_2를 설명-예증-적용 구조로 전개",
        "대지3": "Step2 대지_3을 설명-예증-적용 구조로 전개"
      },
      "결론": "Step2 결론_방향을 구체적 글로 전개 (요약, 도전, 기도)"
    },
    "길이_조절": "시스템에서 지정된 분량에 맞춰 각 섹션 길이 조절"
  },
  "writing_guidelines": {
    "문체": "구어체, 설교 현장에서 바로 사용 가능한 톤",
    "예화": "각 대지당 1개의 적절한 예화 또는 비유 포함",
    "적용": "각 대지 끝에 청중이 실천할 수 있는 구체적 적용 포함",
    "전환": "대지 간 자연스러운 연결 문장 사용"
  },
  "interpretation_rules": {
    "허용": ["Step1/Step2 내용을 문장으로 풀어쓰기", "예화 추가", "적용 구체화", "수사적 표현"],
    "금지": ["Step1에 없는 새로운 성경 해석", "Step2 구조 변경", "대지 순서 변경", "새로운 대지 추가"]
  },
  "quality_criteria": [
    "Step2의 3대지 구조를 정확히 따랐는가",
    "Step1의 해석이 왜곡 없이 반영되었는가",
    "각 대지에 설명-예증-적용이 포함되었는가",
    "지정된 분량에 맞게 작성되었는가",
    "설교 현장에서 바로 사용 가능한 문체인가"
  ]
}
```

---

## 설계 원칙 및 결정 사항

### JSON 지침 설계 원칙

| 원칙 | 설명 |
|------|------|
| 역할 분리 | Step1=분석, Step2=구조화, Step3=작성 (새로운 해석 추가 금지) |
| 절 근거 필수 | 모든 대지는 본문 절 번호 근거 필수 |
| 대지 후보 시스템 | Step1에서 3~5개 후보 제공 → Step2에서 선택 |
| 토큰 효율 | `주요_절_해설` (핵심 절만 분석, 모든 절 X) |

### GPT 검증 후 결정 사항 (2025-11-27)

GPT가 제안한 개선점 중 채택/기각:

| GPT 제안 | 결정 | 이유 |
|----------|------|------|
| `절별_해설` (모든 절) | ⚠️ 축소 채택 | `주요_절_해설` (핵심 절만) - 토큰 효율 |
| `대지_후보요소` 6~10개 | ⚠️ 축소 채택 | 3~5개로 축소 - 선택 기준 명확화 |
| `보충구절_후보` | ❌ 기각 | 본문 외 구절 삽입 위험 |
| `Step1.핵심_메시지` 경로 표기 | ❌ 기각 | 시스템에서 JSON 경로 파싱 안 함 |

---

## 알려진 시스템 제한사항

### 1. 홈 화면 설정(분량, 대상) 전달 문제

**현재 상태**: `executeStep` 함수에서 분량/대상이 API에 전달되지 않음

```javascript
// sermon.html executeStep() - 현재 코드
body: JSON.stringify({
    category, stepId, stepName, stepType, model,
    reference, title, text, guide, masterGuide, previousResults
    // ❌ duration, target 없음
})
```

**영향**: Step3 지침의 `시스템_설정_참조`가 작동하지 않음

**해결 방법** (필요시 구현):
```javascript
duration: document.getElementById('sermon-duration')?.value.trim() || '',
target: document.getElementById('sermon-target')?.value.trim() || ''
```

### 2. 이전 단계 결과 전달 형식

현재 시스템은 이전 단계 결과를 텍스트로 전달:
```
[이전 단계 결과 (참고용)]

### 본문 분석
{Step1 결과}

### 구조 설계
{Step2 결과}
```

→ JSON 경로 접근 불가, GPT가 텍스트로 해석

---

## 다음 세션에서 해야 할 작업

### 1. 3대지 JSON 지침 적용 및 테스트
- [ ] 관리자 공간에서 Step1, Step2, Step3 지침 입력
- [ ] 실제 성경 본문으로 테스트
- [ ] 결과물 품질 검증

### 2. 분량/대상 전달 문제 해결 (선택)
- [ ] executeStep에 duration, target 추가
- [ ] 백엔드에서 플레이스홀더 치환 로직 추가

### 3. 다른 스타일 JSON 지침 작성
- [ ] 강해설교 Step1/Step2/Step3
- [ ] 주제설교 Step1/Step2/Step3
- [ ] 기타 스타일

---

## 파일 변경 목록

| 파일 | 변경 내용 |
|------|----------|
| `templates/sermon.html` | renderGuideTabs() 수정, Step3 지침 전송 추가 |
| `sermon_server.py` | step3_guide 받기, build_step3_prompt_from_json() 전면 개편 |

---

## 관련 함수/변수 위치

### 프론트엔드 (sermon.html)
- `renderGuideTabs()`: 약 3857행
- `executeStep()`: 약 4167행
- Step3 API 호출: 약 3382행
- `getGuideKey()`: 약 2769행
- `stepResults` 객체: 약 1995행

### 백엔드 (sermon_server.py)
- `build_step3_prompt_from_json()`: 약 1458행
- `/api/sermon/gpt-pro`: 약 1894행
- `/api/sermon/process`: 약 1700행
- 이전 결과 전달: 약 1785-1790행
